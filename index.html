<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="零碎的笔记" />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: 'UA-49960399-2'
    },
    sidebar: 'hide'
  };
</script>




  <title> Xiaoke's Blog </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Xiaoke's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            <i class="menu-item-icon icon-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
    </ul>
  

  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/11/how-to-write-an-eventbus-part4/">
                跟我一起写EventBus（四）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-08-11
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android-Java/">Android, Java</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/11/how-to-write-an-eventbus-part4/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/11/how-to-write-an-eventbus-part4/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="项目链接">项目链接</h2><ul>
<li><a href="https://github.com/mcxiaoke/xBus" target="_blank" rel="external"><code>xBus</code> 项目GitHub地址</a></li>
</ul>
<h2 id="系列文章">系列文章</h2><ul>
<li><a href="how-to-write-an-eventbus-part1.md"><code>跟我一起写EventBus（一）</code></a></li>
<li><a href="how-to-write-an-eventbus-part2.md"><code>跟我一起写EventBus（二）</code></a></li>
<li><a href="how-to-write-an-eventbus-part2.md"><code>跟我一起写EventBus（三）</code></a></li>
</ul>
<h2 id="概述">概述</h2><p>前面三部分我们已经实现了一个完整的 <code>EventBus</code> ，这一部分主要是优化和增强，包括事件类型模糊匹配和缓存优化，还有扩展功能和高级用法。</p>
<h2 id="方法缓存">方法缓存</h2><p>Java中的反射虽然速度已经很快，但相对于正常的方法调用来说还是慢很多，使用注解也有不小的性能成本，但是通过使用缓存，一次查找多次使用，可以最大程度较少这个成本，实际使用中几乎可以忽略不计。</p>
<p>对于 <code>xBus</code> 来说，主要两种东西需要缓存，一是某个对象包含的事件接收器方法列表，一个是事件类型对应的泛类型列表。前者是在注册时需要查找，后者是在发送事件时需要查找。下面分开说明。</p>
<h3 id="方法表缓存">方法表缓存</h3><h4 id="数据结构">数据结构</h4><p>实现原理其实非常简单，就是用一个Map保存对象和方法列表，但不是保存原始的 <code>Method</code> 对象，而是保存经过处理的 <code>MethodInfo</code> 对象，第三部分里提到过，这个类保存了一些解析出来的额外信息：比如事件类型和分发模式等，它的结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; targetType;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; eventType;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Bus.EventMode mode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缓存方法的Map定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, Set&lt;MethodInfo&gt;&gt; sMethodCache =</span><br><span class="line">                <span class="keyword">new</span> ConcurrentHashMap&lt;String, Set&lt;MethodInfo&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>使用static是为了跨多个<code>Bus</code>实例共享，鉴于大多数应用都是使用默认的实例，改成普通的非static变量也可以。</p>
<h4 id="缓存流程">缓存流程</h4><p>调用 <code>register(target)</code> 时会检查方法表缓存，如果不存在，就通过 <code>MethodFinder</code> 查找对象的事件接收器方法，然后添加到缓存；如果存在缓存，直接忽略这一步。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> T target)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 真正的实现代码在 addSubscribers() 里</span></span><br><span class="line">    addSubscribers(target);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addSubscribers</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里找出target里包含的所有事件接收器方法</span></span><br><span class="line">    Set&lt;MethodInfo&gt; methods = getMethods(targetType);</span><br><span class="line">    <span class="keyword">for</span> (MethodInfo method : methods) &#123;</span><br><span class="line">        addSubscriber(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找方法和缓存的实现在这里</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;MethodInfo&gt; <span class="title">getMethods</span><span class="params">(Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">    String cacheKey = targetClass.getName();</span><br><span class="line">    Set&lt;MethodInfo&gt; methods;</span><br><span class="line">    <span class="keyword">synchronized</span> (Cache.sMethodCache) &#123;</span><br><span class="line">        methods = Cache.sMethodCache.get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (methods == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果不存在缓存， 就查找一次</span></span><br><span class="line">        methods = mMethodFinder.find(<span class="keyword">this</span>, targetClass);</span><br><span class="line">        <span class="keyword">synchronized</span> (Cache.sMethodCache) &#123;</span><br><span class="line">        <span class="comment">// 然后添加到方法表缓存</span></span><br><span class="line">            Cache.sMethodCache.put(cacheKey, methods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> methods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的测试显示，包含一千个方法的类，一次查找最多可能需要差不多20毫秒，Android应用大多数Activity和Fragment类都不会有这么多方法，大部分情况消耗的时间都在5毫秒以下，详细的性能测试后续会补充。有了缓存之后，后续再进入同一个界面，不需要重复查找，消耗的时间就是零了。</p>
<h3 id="事件类型缓存">事件类型缓存</h3><p>事件类型缓存主要用于事件的泛匹配。在 <code>post(event)</code> 方法中需要用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; theEventType = event.getClass();</span><br><span class="line">    <span class="keyword">final</span> String cacheKey = theEventType.getName();</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; eventTypes;</span><br><span class="line">    <span class="comment">// 检查缓存中是否存在</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Cache.sEventTypeCache) &#123;</span><br><span class="line">        eventTypes = Cache.sEventTypeCache.get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (eventTypes == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果没有缓存， 递归查找父类和接口，然后保存到缓存中</span></span><br><span class="line">        eventTypes = Helper.findSuperTypes(theEventType);</span><br><span class="line">        <span class="keyword">synchronized</span> (Cache.sEventTypeCache) &#123;</span><br><span class="line">            Cache.sEventTypeCache.put(cacheKey, eventTypes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; eventType : eventTypes) &#123;</span><br><span class="line">        postEventByType(event, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件类型模糊匹配">事件类型模糊匹配</h3><p>这个过程可以简单的理解为是 <code>event instanceof ClassType</code> 的过程，如果事件能强制转换为 <code>ClassType</code> 类型，就可以收到事件。举例，假设 <code>post(event)</code> 中 <code>event</code> 的类型是 ClassA，四个接收器方法的参数类型分别是Object，IClass, BaseClass，ClassA，ClassB，ClassC，那么前面四个方法都可以接收到事件，最后两个类型不匹配，收不到事件，代码示例如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IClass</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> <span class="keyword">implements</span> <span class="title">IClass</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassA</span> <span class="keyword">extends</span> <span class="title">BaseClass</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassB</span> <span class="keyword">extends</span> <span class="title">ClassA</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassC</span> <span class="keyword">extends</span> <span class="title">ClassB</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventMatchDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postTestEvent</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 假设发送的事件类型是 ClassA </span></span><br><span class="line">        ClassA event=<span class="keyword">new</span> ClassA();</span><br><span class="line">        Bus.getDefault().post(event);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent0</span><span class="params">(Object event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 所有的类都是Object的子类，能收到</span></span><br><span class="line">       <span class="comment">// (event instanceof Object)==True  </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent0</span><span class="params">(IClass event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// ClassA是IClass的实现类，能收到</span></span><br><span class="line">       <span class="comment">// (event instanceof IClass)==True  </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent1</span><span class="params">(BaseClass event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// ClassA是BaseClass的子类，能收到</span></span><br><span class="line">        <span class="comment">// (event instanceof BaseClass)==True  </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventA</span><span class="params">(ClassA event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// ClassA类型相同，能收到</span></span><br><span class="line">        <span class="comment">//  (event instanceof ClassA)==True  </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventB</span><span class="params">(ClassB event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 收不到，ClassA 不能强制类型转换为ClassB</span></span><br><span class="line">        <span class="comment">// (event instanceof Object)==False  </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventC</span><span class="params">(ClassC event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 收不到，ClassA 不能强制类型转换为ClassC</span></span><br><span class="line">        <span class="comment">// (event instanceof Object)==False  </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的说，发送一个事件 <code>post(event)</code> ，如果 <code>event</code> 对象能转换为 <code>onEvent(SomeType e)</code> 中参数 <code>SomeType</code> 的类型，那么这个方法就能收到事件，否则收不到，遵循Java中一般的类型转换原则。</p>
<h3 id="扩展接口">扩展接口</h3><h4 id="MethodFinder">MethodFinder</h4><p>首先是方法查找接口，默认支持注解和方法名两种方式，实现 <code>MethodFinder</code> ，可以设置自定义的方法查找策略。</p>
<p><code>MethodFinder</code> 接口非常简单，返回给定的对象中符合某些条件的方法列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodFinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Set&lt;MethodInfo&gt; <span class="title">find</span><span class="params">(<span class="keyword">final</span> Bus bus, <span class="keyword">final</span> Class&lt;?&gt; targetClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其它方法">其它方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bus <span class="title">setDebug</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> debug)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Bus <span class="title">setMethodFinder</span><span class="params">(<span class="keyword">final</span> MethodFinder finder)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Bus <span class="title">setStrictMode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> strictMode)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2><p>到这里，我们实现了一个完整的 <code>EventBus</code> ，它已经可以用在实际项目中。下一部分，也是最后一部分会介绍它的使用方法和一些自定义配置。</p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/10/how-to-write-an-eventbus-part3/">
                跟我一起写EventBus（三）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-08-10
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android-Java/">Android, Java</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/10/how-to-write-an-eventbus-part3/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/10/how-to-write-an-eventbus-part3/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="项目链接">项目链接</h2><ul>
<li><a href="https://github.com/mcxiaoke/xBus" target="_blank" rel="external"><code>xBus</code> 项目GitHub地址</a></li>
</ul>
<h2 id="概述">概述</h2><p>在 <a href="/2015/08/03/how-to-write-an-eventbus-part1/"><code>跟我一起写EventBus（一）</code></a> 里实现了一个非常粗糙的<code>EventBus</code>，在 <a href="/2015/08/04/how-to-write-an-eventbus-part2/"><code>跟我一起写EventBus（二）</code></a> ，又增加了基类中注册和事件类型宽泛匹配的功能，这一节需要加上在不同线程分发事件的功能，下面会详细解释事件的分发流程。</p>
<p>在不同的线程分发事件（即在指定的线程调用使用了 <code>@BusReceiver</code> 注解的事件接收器的方法），主要支持三种线程：</p>
<ol>
<li>事件发送者（调用 <code>post(event)</code>方法）所在的线程，这是上一版的处理方式，对于大部分场景来说，这都不太合适；</li>
<li>主线程（UI线程），对Android来说，异步任务完成后一般是更新界面，而更新UI必须在主线程中操作，所以这是一个主要用例；</li>
<li>独立线程，另外维护一个线程池，在单独的线程中处理事件，这个适用于需要在事件接收器方法中进行耗时操作的情况，可以避免堵塞发送者线程或主线程。</li>
</ol>
<h2 id="Scheduler接口">Scheduler接口</h2><p>在不同的线程分发事件，需要一个调度器，这里定义一个简单的调度器 <code>Scheduler</code> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(Runnable runnable)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这和java.util.concurrent.Executor的接口几乎是一样的，其实可以直接使用这个接口，后面接口的实现需要扩充一些功能</span></span><br></pre></td></tr></table></figure>
<p>调度器的作用很简单，就是执行一个 <code>Runnable</code> 定义的任务，可以是同步的、异步的，具体看实现类的定义。</p>
<h3 id="发送者线程分发">发送者线程分发</h3><p>发送者线程分发是最简单的，直接调用事件接收器的方法即可，使用 <code>Scheduler</code> 接口的实现就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SenderScheduler</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bus mBus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SenderScheduler</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">        mBus = bus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 直接调用方法，就是在调用者线程</span></span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="主线程分发">主线程分发</h3><p>针对Android系统的特点，要在主线程分发事件，需要用到 <code>Handler</code> ，再定义一个使用Handler的调度器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HandlerScheduler</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bus mBus;</span><br><span class="line">    <span class="keyword">private</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerScheduler</span><span class="params">(<span class="keyword">final</span> Bus bus, <span class="keyword">final</span> Handler handler)</span> </span>&#123;</span><br><span class="line">        mBus = bus;</span><br><span class="line">        mHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> Runnable runnable)</span> </span>&#123;</span><br><span class="line">        mHandler.post(runnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了 <code>HandlerScheduler</code> 这个类，要实现在主线程分发事件就简单了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Scheduler <span class="title">getMainThreadScheduler</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> HandlerScheduler(bus, <span class="keyword">new</span> Handler(Looper.getMainLooper()));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="独立线程分发">独立线程分发</h3><p>要在独立线程分发事件，可以使用并发框架里的 <code>Executor</code> ，不用额外的维护线程的创建和终止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecutorScheduler</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bus mBus;</span><br><span class="line">    <span class="keyword">private</span> Executor mExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorScheduler</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">        mBus = bus;</span><br><span class="line">        mExecutor = Executors.newCachedThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">final</span> Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 在线程池中执行任务</span></span><br><span class="line">        mExecutor.execute(runnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Scheduler使用">Scheduler使用</h2><h3 id="定义">定义</h3><p>最后创建三种调度器的工厂方法，调度器这边就准备好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Schedulers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">sender</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SenderScheduler(bus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">getMainThreadScheduler</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HandlerScheduler(bus, <span class="keyword">new</span> Handler(Looper.getMainLooper()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">thread</span><span class="params">(<span class="keyword">final</span> Bus bus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorScheduler(bus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件模式">事件模式</h3><p>在<code>Bus</code>类中使用Enum定义三种事件分发模式，在Android应用中，绝大部分的事件处理都是更新界面，因为这里把主线程分发定为默认模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 事件发送模式：</span><br><span class="line"> *</span><br><span class="line"> * Sender - 在发送者的线程调用<span class="doctag">@BusReceiver</span>/onEvent方法</span><br><span class="line"> * Main - 在主线程调用<span class="doctag">@BusReceiver</span>/onEvent方法（默认为此模式）</span><br><span class="line"> * Thread - 在一个单独的线程调用<span class="doctag">@BusReceiver</span>/onEvent方法</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EventMode &#123;</span><br><span class="line"></span><br><span class="line">    Sender, Main, Thread</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用方法">使用方法</h3><p>在事件接收器方法中使用mode指定分发模式，默认是主线程分发，示例如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// default is main thread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent0</span><span class="params">(String event)</span></span>&#123;</span><br><span class="line">    <span class="comment">// handle event </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@BusReceiver</span>(mode= EventMode.Main)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent1</span><span class="params">(String event)</span></span>&#123;</span><br><span class="line">   <span class="comment">// handle event </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@BusReceiver</span>(mode= EventMode.Sender)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent2</span><span class="params">(String event)</span></span>&#123;</span><br><span class="line">    <span class="comment">// handle event </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@BusReceiver</span>(mode= EventMode.Thread)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent3</span><span class="params">(String event)</span></span>&#123;</span><br><span class="line">    <span class="comment">// handle event </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="事件分发流程">事件分发流程</h2><p>目标调用 <code>Bus.getDefault().register(target)</code> 的时候，查找目标对象中包含的事件接收器方法，然后构造 <code>MethodInfo</code> 对象和 <code>Subscriber</code> 对象，保存在Map中，同时保存事件类型和 <code>Subscriber</code> 直接的对应关系，发送者调用 <code>post(event)</code> 时会从Map中查找事件对应的订阅者，然后根据事件分发模式使用 <code>Scheduler</code> 分发事件，大概流程就是这样的，下面是几个重要的数据结构。</p>
<h3 id="EventEmitter">EventEmitter</h3><p><code>Scheduler</code> 接受的是 <code>Runnable</code> 参数，因此我们实现一个事件发送器类 <code>EventEmitter</code> ，它实现了 <code>Runnable</code> 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventEmitter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = Bus.TAG;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Bus bus; <span class="comment">// Bus对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object event; <span class="comment">// 事件对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Subscriber subscriber; <span class="comment">// 订阅关系</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Bus.EventMode mode; <span class="comment">// 分发模式</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventEmitter</span><span class="params">(<span class="keyword">final</span> Bus bus, <span class="keyword">final</span> Object event,</span><br><span class="line">                        <span class="keyword">final</span> Subscriber subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bus = bus;</span><br><span class="line">        <span class="keyword">this</span>.event = event;</span><br><span class="line">        <span class="keyword">this</span>.subscriber = subscriber;</span><br><span class="line">        <span class="keyword">this</span>.mode = subscriber.mode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subscriber.invoke(event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Subscriber">Subscriber</h3><p><code>Subscriber</code> 类保存事件类型，事件接收器方法和事件目标之间的关系，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> MethodInfo method;<span class="comment">// 保存事件方法的信息，下面会解释</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object target; <span class="comment">// 事件目标对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; targetType; <span class="comment">// 目标类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; eventType; <span class="comment">// 事件类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Bus.EventMode mode; <span class="comment">// 分发模式</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String name; <span class="comment">// 名字</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Subscriber</span><span class="params">(<span class="keyword">final</span> MethodInfo method, <span class="keyword">final</span> Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.method = method;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.eventType = method.eventType;</span><br><span class="line">        <span class="keyword">this</span>.targetType = method.targetType;</span><br><span class="line">        <span class="keyword">this</span>.mode = method.mode;</span><br><span class="line">        <span class="keyword">this</span>.name = method.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object event)</span></span><br><span class="line">            <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.method.method.invoke(<span class="keyword">this</span>.target, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MethodInfo">MethodInfo</h3><p><code>MethodInfo</code> 保存通过注解或方法名查找到的事件接收器方法的信息，包含 <code>Method</code> 对象和参数类型（也就是接受的事件类型），还有注解指定的分发模式，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; targetType;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; eventType;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Bus.EventMode mode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodInfo</span><span class="params">(<span class="keyword">final</span> Method method, <span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> Bus.EventMode mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.method = method;</span><br><span class="line">        <span class="keyword">this</span>.targetType = targetClass;</span><br><span class="line">        <span class="keyword">this</span>.eventType = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">this</span>.mode = mode;</span><br><span class="line">        <span class="keyword">this</span>.name = targetType.getName() + <span class="string">"."</span> + method.getName()</span><br><span class="line">                + <span class="string">"("</span> + eventType.getName() + <span class="string">")"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分发事件">分发事件</h3><p>发送者调用 <code>post(event)</code> 方法时， <code>Bus</code> 会找到所有可能的接受者，然后构造  <code>EventEmitter</code> 对象，调用 <code>sendEvent(emitter)</code> 方法根据接受者指定的分发模式分发每一个事件，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendEvent</span><span class="params">(EventEmitter emitter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (EventMode.Sender.equals(emitter.mode)) &#123;</span><br><span class="line">        mSenderScheduler.post(emitter);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EventMode.Main.equals(emitter.mode)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Helper.isMainThread()) &#123;</span><br><span class="line">            mSenderScheduler.post(emitter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mMainScheduler.post(emitter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EventMode.Thread.equals(emitter.mode)) &#123;</span><br><span class="line">        mThreadScheduler.post(emitter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2><p>以上就是在发送者线程、主线程、独立线程分发事件的全过程，下一节会介绍事件类型的模糊匹配和缓存优化，还有扩展功能和高级用法。</p>
<h2 id="系列文章">系列文章</h2><ul>
<li><a href="https://github.com/mcxiaoke/xBus#实现教程" target="_blank" rel="external"><code>跟我一起写EventBus（一）</code></a></li>
<li><a href="https://github.com/mcxiaoke/xBus#实现教程" target="_blank" rel="external"><code>跟我一起写EventBus（二）</code></a> </li>
</ul>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/04/how-to-write-an-eventbus-part2/">
                跟我一起写EventBus（二）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-08-04
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android-Java/">Android, Java</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/04/how-to-write-an-eventbus-part2/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/04/how-to-write-an-eventbus-part2/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="项目链接">项目链接</h2><ul>
<li><a href="https://github.com/mcxiaoke/xBus" target="_blank" rel="external"><code>xBus</code> 项目GitHub地址</a></li>
</ul>
<h2 id="概述">概述</h2><p>在 <a href="/2015/08/03/how-to-write-an-eventbus-part1/">跟我一起写EventBus（一）</a> 里我们实现了一个非常粗糙的<code>EventBus</code>，在这一节里面我们要给这个<code>EventBus</code>添加以下两个功能：</p>
<ul>
<li>支持在基类中调用 <code>register(target)</code> 注册，调用 <code>unregister(target)</code> 取消注册</li>
<li>发送事件时， <code>post(event)</code> 支持匹配基类的事件接收器</li>
</ul>
<h2 id="基类注册">基类注册</h2><p>支持 <code>register</code> 和 <code>unregister</code> 在基类中使用，用法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bus.getDefault().register(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bus.getDefault().unregister(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="事件类型">事件类型</h2><p><code>post(event)</code> 中的 <code>event</code> 可以是事件接收器的参数 <code>eventType</code> 的实现类或子类，用法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 运行这个Demo，控制台的输出是：</span><br><span class="line"> * onCharSequenceEvent() event=A StringBuilder</span><br><span class="line"> * onObjectEvent() event=A StringBuilder</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> EventDemo().run();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bus.getDefault().register(<span class="keyword">this</span>);</span><br><span class="line">        Bus.getDefault().post(<span class="keyword">new</span> StringBuilder(<span class="string">"A StringBuilder"</span>));</span><br><span class="line">        Bus.getDefault().unregister(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStringEvent</span><span class="params">(String event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不会执行，因为event是StringBuilder，event instanceof String == false</span></span><br><span class="line">        System.out.println(<span class="string">"onStringEvent() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExceptionEvent</span><span class="params">(Exception event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不会执行，因为event是StringBuilder，event instanceof Exception == false</span></span><br><span class="line">        System.out.println(<span class="string">"onExceptionEvent() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCharSequenceEvent</span><span class="params">(CharSequence event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 会执行，因为event是StringBuilder，event instanceof CharSequence == true</span></span><br><span class="line">        System.out.println(<span class="string">"onCharSequenceEvent() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onObjectEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 会执行，因为event是StringBuilder，event instanceof Object == true</span></span><br><span class="line">        System.out.println(<span class="string">"onObjectEvent() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="功能实现">功能实现</h2><p>下面我们来看看如何实现这两个功能</p>
<h3 id="支持在基类中注册">支持在基类中注册</h3><p>首先，注册和取消注册这两个方法默认支持在基类中使用，因为实际运行的程序中并不存在基类的实例，即使你在基类中调用 <code>register(target)</code> ，这个 <code>target</code> 也是实际运行的子类对象，所以基类中注册指示集中了代码，并没有改变运行时的行为。</p>
<p>但是，之前版本的 <code>EventBus</code> 在查找事件接收器方法时只查找了当前类中的方法，忽略了父类和继承链上的方法，因此需要修改先前版本的 <code>findAnnotatedMethods</code> 方法，最简单的思路就是一个 <code>while</code> 循环，递归查找当前类和父类的方法，然后过滤出符合条件的事件接收器方法，我们把检查方法是否符合条件的代码先提到一个单独的方法，叫 <code>isAnnotatedMethod</code> ，然后 <code>findAnnotatedMethods</code> 方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Method&gt; <span class="title">findAnnotatedMethods</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; type,</span><br><span class="line">                                               <span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = type;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;Method&gt; methods = <span class="keyword">new</span> HashSet&lt;Method&gt;();</span><br><span class="line">    <span class="comment">// 逐级查找父类的方法，遇到Object类时停止</span></span><br><span class="line">    <span class="keyword">while</span> (clazz!=Object.class) &#123;</span><br><span class="line">        <span class="keyword">final</span> Method[] allMethods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : allMethods) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isAnnotatedMethod(method, annotation)) &#123;</span><br><span class="line">                methods.add(method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// search more methods in super class</span></span><br><span class="line">        clazz = clazz.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> methods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，和之前版本的差别不大，逻辑几乎一样，就是增加了递归父类查找。这里可以做一点优化，实际查找父类时不需要查找JDK自带的类，针对Android系统，也不需要查找系统框架中的类，因此增加了一个优化的判断方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldSkipClass</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String clsName = clazz.getName();</span><br><span class="line">    <span class="keyword">return</span> Object.class.equals(clazz)</span><br><span class="line">            || clsName.startsWith(<span class="string">"java."</span>)</span><br><span class="line">            || clsName.startsWith(<span class="string">"javax."</span>)</span><br><span class="line">            || clsName.startsWith(<span class="string">"android."</span>)</span><br><span class="line">            || clsName.startsWith(<span class="string">"com.android."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 <code>while (clazz!=Object.class)</code> 改成 <code>!shouldSkipClass(clazz)</code> ，其它部分不变，这样修改之后，可以大幅提高父类查找的效率，减少很多不必要的遍历。</p>
<p>下面是提取出来的 <code>isAnnotatedMethod</code> 方法，用于判断某个方法是否满足事件接收器的要求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAnnotatedMethod</span><span class="params">(<span class="keyword">final</span> Method method,</span><br><span class="line">                                         <span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否使用了@BusReceiver的注解，这个放在最上面，一点效率优化</span></span><br><span class="line">    <span class="keyword">if</span> (!method.isAnnotationPresent(annotation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤掉非public的方法</span></span><br><span class="line">    <span class="keyword">if</span> (!Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤掉`static`的方法</span></span><br><span class="line">    <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤掉volatile的方法，这里是修复Java编译器自动添加bridge方法造成的方法重复的问题，具体细节比较复杂，这里不提了</span></span><br><span class="line">    <span class="comment">// 这里实际过滤掉的是BRIDGE修饰符修饰的方法，观察Modifier类中的常量定义可以发现，BRIDGE和VOLATILE的值都是0x00000040，但是不存在一个叫Modifier.isBridge的方法，所以用Modifier.isVolatile替代，效果相同</span></span><br><span class="line">    <span class="comment">// Java代码中不允许使用volatile修饰方法，但是编译器不受此限制。还需要提一下的是，Method类中的equals方法没有使用修饰符比较。</span></span><br><span class="line">    <span class="comment">// fix getDeclaredMethods <span class="doctag"><span class="keyword">bug</span></span>, if method in base class,</span></span><br><span class="line">    <span class="comment">// it returns duplicate method,</span></span><br><span class="line">    <span class="comment">// one is normal, the other is the same but with volatile modifier</span></span><br><span class="line">    <span class="keyword">if</span> (Modifier.isVolatile(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// must has only one parameter</span></span><br><span class="line">    <span class="keyword">if</span> (method.getParameterTypes().length != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件类型的匹配">事件类型的匹配</h3><p>在第一节中 <code>EventBus</code> 的实现只支持事件类型对象的精确匹配，那个版本的 <code>post(event)</code> 方法中对事件类型的判断是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (eventClass.equals(method.getParameterTypes()[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<p>我们修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; parameterClass = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (parameterClass.isAssignableFrom(eventClass)) &#123;</span><br><span class="line"><span class="comment">// post event to receiver</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里解释一下，对于 <code>objectA.isAssignableFrom(classB)</code> ，当 <code>objectA</code> 是 <code>classB</code> 的实现类（如果 <code>classB</code> 是一个接口）或其子类时返回 <code>true</code> ，这里我们判断如果事件类是事件接收器的参数类的实现类或子类就可以向它发送事件。</p>
<h2 id="一点优化">一点优化</h2><p>第一版 <code>EventBus</code> 我们使用 <code>List&lt;Method&gt;</code> 保存某个对象的方法列表，实际上我们要求这个列表不能有重复的方法存在，所以可以改用<code>Set</code>实现，几处修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// findAnnotatedMethods 方法返回一个 Set&lt;Method&gt;</span></span><br><span class="line"><span class="keyword">final</span> Set&lt;Method&gt; methods = <span class="keyword">new</span> HashSet&lt;Method&gt;();</span><br><span class="line">        <span class="keyword">while</span> (!shouldSkipClass(clazz)) &#123;...&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// Bus类中的mMethodMap类型修改为 Map&lt;Object, Set&lt;Method&gt;&gt;</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Object, Set&lt;Method&gt;&gt; mMethodMap = <span class="keyword">new</span> WeakHashMap&lt;Object, Set&lt;Method&gt;&gt;();</span><br></pre></td></tr></table></figure>
<h2 id="完整代码">完整代码</h2><ul>
<li>完整的代码见 <a href="https://github.com/mcxiaoke/xBus/tree/tutorial-part2/src/main/com/mcxiaoke/bus" target="_blank" rel="external">tutorial-part2-code</a></li>
<li>代码打包下载 <a href="https://github.com/mcxiaoke/xBus/archive/tutorial-part2.zip" target="_blank" rel="external">tutorial-part2-zip</a></li>
</ul>
<h2 id="进一步的问题">进一步的问题</h2><p>这个版本增加了对继承的支持，放宽了事件接收器参数匹配的规则，还完善了一些细节，做了一些简单的优化，离实用更进一步了，后面还有不少问题需要解决，如下：</p>
<ol>
<li><code>post(event)</code> 方法需要遍历保存所有目标对象的所有方法，这个在方法数量很大时效率同样存在问题，可以改进一下遍历过程，或者可以加缓存，不用每次都遍历。</li>
<li><code>Bus</code> 类直接保存了目标对象 <code>target</code> 的强引用，如果使用者忘记调用 <code>unregister(target)</code> 方法取消注册，可能造成内存泄露，任何改进。</li>
<li><code>Bus</code> 的实现没有考虑在多个线程中使用的问题，没有添加任何同步代码，可能会造成内部数据的不同步，或者发生错误。</li>
<li><code>Bus</code> 的实现不支持外部配置，限定了事件接收器方法只能使用 <code>@BusReceiver</code> ，且只能是<code>public</code>的，只能带一个参数，能不能支持使用者自定义这些行为。</li>
<li>当前的事件接收器不支持泛型参数，不支持集合类型，如果支持，还可以考虑，如何支持多个事件参数和可变参数类型的事件。</li>
<li>当前的 <code>post(event)</code> 方法是在调用者线程执行，在很多情况下，使用者可能需要任务执行的线程和事件接收器的线程是分开的，比如在某个后台线程中执行异步任务，在主线程中接收事件更新界面，这个需要支持用户自定义。</li>
<li>目前的<code>Bus</code>实现没有任何异常处理的代码，一个健壮的程序不能缺少完善的异常处理。</li>
</ol>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/03/how-to-write-an-eventbus-part1/">
                跟我一起写EventBus（一）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-08-03
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android-Java/">Android, Java</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/08/03/how-to-write-an-eventbus-part1/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/03/how-to-write-an-eventbus-part1/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="项目链接">项目链接</h2><ul>
<li><a href="https://github.com/mcxiaoke/xBus" target="_blank" rel="external"><code>xBus</code> 项目GitHub地址</a></li>
</ul>
<h2 id="什么是EventBus">什么是<code>EventBus</code></h2><p>先介绍一下概念， <code>EventBus</code> 直译过来就是<code>事件总线</code>，它使用发布订阅模式支持组件之间的通信，不需要显式地注册回调，比观察者模式更灵活，可用于替换Java中传统的事件监听模式，<code>EventBus</code>的作用就是解耦，它不是通用的发布订阅系统，也不能用于进程间通信。可用于Android的<code>EventBus</code>库主要有这几个：Google出品的<code>Guava</code>，<code>Guava</code>是一个庞大的库，<code>EventBus</code> 只是它附带的一个小功能，因此实际项目中使用并不多。用的最多的是<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external"><code>greenrobot/EventBus</code></a>，这个库的优点是接口简洁，集成方便，但是限定了方法名，不支持注解。另一个库<a href="https://github.com/square/otto" target="_blank" rel="external"><code>square/otto</code></a>修改自 <code>Guava</code> ，用的人也不少。</p>
<p>以 <code>greenrobot/EventBus</code> 为例，我们看一下 <code>EventBus</code> 模式的典型用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 注册EventBus，接受事件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>&#123;</span><br><span class="line">       EventBus.getDefault().register(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">       EventBus.getDefault().unregister(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(SomeEvent1 event)</span></span>&#123;</span><br><span class="line">        <span class="comment">// handle event</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理任务，发送事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// do your work</span></span><br><span class="line">        <span class="comment">// send event</span></span><br><span class="line">        EventBus.getDefault().post(<span class="keyword">new</span> SomeEvent1());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接口定义">接口定义</h2><p>我们的目标是从零开始自己写一个 <code>EventBus</code> ，参考上面的示例，首先定义接口，假设接口叫 <code>IBus</code> ，实现类叫 <code>Bus</code> ，它最少需要三个方法。为了灵活和简洁，暂时不考虑性能，我们采用 <code>Annotation</code> 的方式指定事件接收者。</p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBus</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// register event target</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">(Object target)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unregister event target</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unregister</span><span class="params">(Object target)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post event</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最简单的用法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeEvent</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> BusDemo().show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册EventBus，发送事件</span></span><br><span class="line">    <span class="comment">// 这里为了演示，全部放在一个地方</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bus.getDefault().register(<span class="keyword">this</span>);</span><br><span class="line">        Bus.getDefault().post(<span class="keyword">new</span> SomeEvent());</span><br><span class="line">        Bus.getDefault().unregister(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须使用这个Annotation</span></span><br><span class="line">    <span class="comment">// 必须是接受一个参数的public方法，没有其它限制</span></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(SomeEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onReceive() event="</span> + event);</span><br><span class="line">        <span class="comment">// handle your event here...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接口分析">接口分析</h2><p>上面定义的 <code>IBus</code> 接口有三个方法 <code>register(target)</code> ， <code>unregister(target)</code> ， <code>post(event)</code> ，事件接收器使用<code>Annotation</code>的方式指定，下面逐一考察这些问题：</p>
<ol>
<li>按照接口定义， <code>register(target)</code> 方法用于注册事件接收器的目标对象，我们需要保存这个对象，同时还需要查找这个对象中存在的事件接收器方法，上面说了，这些事件接受器是使用了 <code>@BusReceiver</code> 注解的 <code>public</code> 方法，查找出这些方法之后需要保存这些方法，后续 <code>post(event)</code> 发送事件的时候需要用到。</li>
<li><code>unregister(target)</code> 方法用于取消注册目标对象，调用这个方法之后，不能再给这个对象发送任何事件，也就是要从保存的事件目标对象集合里移除这个对象和对应的事件接收器方法集合，这要求我们能找到这个对象以及这个对象中的事件接受器对象集合。</li>
<li><code>post(event)</code> 方法用于发送事件给目标对象，也就是调用注册了这个事件接收器的方法，这要求我们可以通过事件对象或时间对象类型找到对应的目标对象( <code>target</code> )和事件接收器( ‘@BusReceiver’ )方法。</li>
<li>事件接收器通过 <code>@BusReceiver</code> 这个注解指定，因此我们需要在 <code>register(target)</code> 的时候目标对象中所有使用了这个注解的方法，并排除非 <code>public</code> 的方法， <code>static</code> 方法也需要排除，没有参数或参数超过一个的也要排除。</li>
</ol>
<h2 id="开始实现">开始实现</h2><h3 id="查找使用_@BusReceiver_的方法">查找使用 <code>@BusReceiver</code> 的方法</h3><p>首先我们要定义 <code>BusReceiver</code> 注解，它的定义很简单，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD) <span class="comment">// 表示这个注解适用于方法</span></span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">//表示这个注解需要保留到运行时</span></span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> BusReceiver &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们定义一个通用一点的方法叫 <code>findAnnotatedMethods(class,annotation)</code> ，用于查找给定的<code>class</code>里面使用了 <code>Annotation</code> 的方法，为了简化问题，我们先忽略从父类继承的方法，只查找指定类的方法，这个方法是个通用的工具方法，可以放在一个单独的类中，定义为静态方法，假设这个类为<code>Helper</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Method&gt; <span class="title">findAnnotatedMethods</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; type,</span><br><span class="line">                                                    <span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;();</span><br><span class="line"><span class="comment">//        Class&lt;?&gt; clazz = type;</span></span><br><span class="line">        <span class="comment">// for now ignore super class, handle current class only</span></span><br><span class="line">        Method[] ms = type.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : ms) &#123;</span><br><span class="line">            methods.add(method);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这是最简单的查找使用了某个特定注解的方法，按照我们接口的定义，事件接收器方法需要满足这几个条件：</p>
<ul>
<li>使用了 <code>@BusReceiver</code> 注解</li>
<li>是 <code>public</code> 方法，并且不是 <code>static</code> 方法</li>
<li>参数只能是一个，不能没有也不能是多个</li>
</ul>
<p>按照这个条件加上过滤， <code>findAnnotatedMethods</code> 方法最终是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Method&gt; <span class="title">findAnnotatedMethods</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; type,</span><br><span class="line">                                                    <span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;();</span><br><span class="line"><span class="comment">//        Class&lt;?&gt; clazz = type;</span></span><br><span class="line">        <span class="comment">// for now ignore super class, handle current class only</span></span><br><span class="line">        Method[] ms = type.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : ms) &#123;</span><br><span class="line">            <span class="comment">// must not static</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// must be public</span></span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// must has only one parameter</span></span><br><span class="line">            <span class="keyword">if</span> (method.getParameterTypes().length != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// must has annotation</span></span><br><span class="line">            <span class="keyword">if</span> (!method.isAnnotationPresent(annotation)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            methods.add(method);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为判断 <code>Method</code> 的修饰符和参数列表长度比较快， 我们放在前面， <code>method.isAnnotationPresent</code> 这个方法比较慢，放在最后。</p>
<h3 id="register(target)_的实现"><code>register(target)</code> 的实现</h3><p>有了 <code>findAnnotatedMethods</code> 方法， <code>register(target)</code> 的实现就简单多了，这个方法需要找出所有符合条件的事件接收器方法，然后保存起来，由于后面我们要根据对象查找方法，我们将 <code>target:method</code> 关系保存到一个<code>Map</code>中，假设我们的<code>IBus</code>接口的实现类叫<code>Bus</code>，在<code>Bus</code>类中增加一个成员变量保存它们：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;Object, List&lt;<span class="function"><span class="keyword">Method</span>&gt;&gt; <span class="title">mMethodMap</span> = <span class="title">new</span> <span class="title">HashMap</span>&lt;<span class="title">Object</span>, <span class="title">List</span>&lt;<span class="title">Method</span>&gt;&gt;<span class="params">()</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> void <span class="keyword">register</span>(<span class="keyword">final</span> Object target) <span class="comment">&#123;</span><br><span class="line">    List&lt;Method&gt; methods = Helper.findAnnotatedMethods(target.getClass(), BusReceiver.class);</span><br><span class="line">    if (methods == null || methods.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span></span><br><span class="line">    mMethodMap.put(target, methods);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="unregister(target)_的实现"><code>unregister(target)</code> 的实现</h3><p>有了上面保存的 <code>mMethodMap</code> 数据，取消注册目标就是移除目标对象注册过的所有事件接收器方法，可以这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(<span class="keyword">final</span> Object target)</span> </span>&#123;</span><br><span class="line">    mMethodMap.remove(target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="post(event)_的实现"><code>post(event)</code> 的实现</h3><p><code>xBus</code>的使用者在完成某项任务之后调用 <code>post(event)</code> 方法发送事件，这个方法会遍历所有注册过的<code>target</code>里包含的，接受这个事件的事件接收器方法，因此需要知道怎么从事件对象找到事件接收器，由于可能有多个<code>target</code>都注册了这个事件的接收器，因此我们需要遍历所有的目标对象，找到符合条件的方法，然后调用这些方法。怎么样才算符合条件呢，首先要符合 <code>findAnnotatedMethods</code> 那里提到的条件：使用 <code>@BusReceiver</code> 注解，是 <code>publici</code> 且非 <code>static</code> 方法，有且只有一个参数，针对某个事件 <code>event</code> ，还需要参数类型是一致的，举例说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对类型为`SomeEvent`的事件`event`，只能发送给如下形式的事件接收器：</span></span><br><span class="line"><span class="comment">// 这里方法名字没有要求，但是注解和方法参数签名不能变</span></span><br><span class="line"><span class="annotation">@BusReceier</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">anyMethodName</span><span class="params">(SomeEvent event)</span></span>&#123;</span><br><span class="line"><span class="comment">// handle event</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>能想到的最直接的查找思路就是遍历 <code>mMethods</code> 列表，逐个对比，找出符合要求的方法，然后调用对应的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, List&lt;Method&gt;&gt; entry : mMethodMap.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">final</span> Object target = entry.getKey();</span><br><span class="line">        <span class="keyword">final</span> List&lt;Method&gt; methods = entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (methods == <span class="keyword">null</span> || methods.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="comment">// 如果事件类型相符，就调用对应的方法发送事件</span></span><br><span class="line">        <span class="comment">// 这里的类型是要求精确匹配的，没有考虑继承</span></span><br><span class="line">            <span class="keyword">if</span> (eventClass.equals(method.getParameterTypes()[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    method.invoke(target, event);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试一下">测试一下</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BusDemo demo = <span class="keyword">new</span> BusDemo();</span><br><span class="line">        Bus bus = Bus.getDefault();</span><br><span class="line">        bus.register(demo);</span><br><span class="line">        bus.post(<span class="keyword">new</span> Object());</span><br><span class="line">        bus.post(<span class="string">"SomeEvent"</span>);</span><br><span class="line">        bus.post(<span class="number">12345</span>);</span><br><span class="line">        bus.post(<span class="keyword">new</span> RuntimeException(<span class="string">"Error"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有发送这个事件</span></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveRunnableNotPost</span><span class="params">(Runnable event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onReceiveRunnableNotPost() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onObjectEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onObjectReceive() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送的事件是`RuntimeException`，不是精确匹配`Exception`</span></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExceptionEvent</span><span class="params">(Exception event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onExceptionEvent() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStringReceive</span><span class="params">(String event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onStringReceive() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BusReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInteger</span><span class="params">(Integer event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onInteger() event="</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整代码">完整代码</h2><ul>
<li>完整的代码见 <a href="https://github.com/mcxiaoke/xBus/tree/tutorial-part1/src/main/com/mcxiaoke/bus" target="_blank" rel="external">tutorial-part1/src/main</a></li>
<li>详细的示例见 <a href="https://github.com/mcxiaoke/xBus/tree/tutorial-part1/src/demo/com/mcxiaoke/bus/demo" target="_blank" rel="external">tutorial-part1/src/demo</a></li>
<li>代码打包下载 <a href="https://github.com/mcxiaoke/xBus/archive/tutorial-part1.zip" target="_blank" rel="external">archive/tutorial-part1.zip</a></li>
</ul>
<h2 id="进一步的问题">进一步的问题</h2><p>这个粗糙的版本只是实现了一个最基本的<code>EventBus</code>的功能，如果想把它用在实际的项目中，还需要考虑很多问题，比如：</p>
<ol>
<li><code>findAnnotatedMethods</code> 方法没有考虑效率问题，如果某个<code>target</code>中有成千上万个方法，这个方法可能比较慢，是需要考虑缓存或其它的优化方法。</li>
<li><code>post(event)</code>方法需要遍历保存所有目标对象的所有方法，这个在方法数量很大时效率同样存在问题，可以改进一下遍历过程，或者可以加缓存，不用每次都遍历。</li>
<li><code>Bus</code>类直接保存了目标对象<code>target</code>的强引用，如果使用者忘记调用 <code>unregister(target)</code> 方法取消注册，可能造成内存泄露，任何改进。</li>
<li><code>Bus</code>的实现没有考虑在多个线程中使用的问题，没有添加任何同步代码，可能会造成内部数据的不同步，或者发生错误。</li>
<li><code>Bus</code>的实现不支持外部配置，限定了事件接收器方法只能使用 <code>@BusReceiver</code> ，且只能是<code>public</code>的，只能带一个参数，能不能支持使用者自定义这些行为。</li>
<li><code>Bus</code>目前的版本不支持继承，既不支持在基类中注册，也不支持事件接收器方法中参数类型的继承，如何支持。</li>
<li>当前的事件接收器不支持泛型参数，不支持集合类型，如果支持，还可以考虑，如何支持多个事件参数和可变参数类型的事件。</li>
<li>当前的<code>post(event)</code>方法是在调用者线程执行，在很多情况下，使用者可能需要任务执行的线程和事件接收器的线程是分开的，比如在某个后台线程中执行异步任务，在主线程中接收事件更新界面，这个需要支持用户自定义。</li>
<li>目前的<code>Bus</code>实现没有任何异常处理的代码，一个健壮的程序不能缺少完善的异常处理。</li>
</ol>
<p>这些问题都是一个完整的 <code>EventBus</code> 实现需要考虑的问题，教程的后续部分将逐步实现这些功能，解决存在的问题。</p>
<h2 id="相关阅读">相关阅读</h2><h4 id="什么是EventBus-1">什么是EventBus</h4><p><a href="https://code.google.com/p/guava-libraries/wiki/EventBusExplained" target="_blank" rel="external">https://code.google.com/p/guava-libraries/wiki/EventBusExplained</a><br><a href="http://doc.akka.io/docs/akka/snapshot/java/event-bus.html" target="_blank" rel="external">http://doc.akka.io/docs/akka/snapshot/java/event-bus.html</a>  </p>
<h4 id="EventBus的实现">EventBus的实现</h4><p><a href="http://javarticles.com/2015/04/guava-eventbus-examples.html" target="_blank" rel="external">http://javarticles.com/2015/04/guava-eventbus-examples.html</a><br><a href="http://timnew.me/blog/2014/12/06/typical-eventbus-design-patterns/" target="_blank" rel="external">http://timnew.me/blog/2014/12/06/typical-eventbus-design-patterns/</a><br><a href="https://code.google.com/p/simpleeventbus/" target="_blank" rel="external">https://code.google.com/p/simpleeventbus/</a><br><a href="https://github.com/greenrobot/EventBus/blob/master/HOWTO.md" target="_blank" rel="external">https://github.com/greenrobot/EventBus/blob/master/HOWTO.md</a>  </p>
<h4 id="EventBus的使用">EventBus的使用</h4><p><a href="http://www.cnblogs.com/peida/p/eventbus.html" target="_blank" rel="external">http://www.cnblogs.com/peida/p/eventbus.html</a><br><a href="http://blog.cainwong.com/using-an-eventbus-in-android-pt-1-why-an-eventbus/" target="_blank" rel="external">http://blog.cainwong.com/using-an-eventbus-in-android-pt-1-why-an-eventbus/</a><br><a href="http://blog.cainwong.com/using-an-eventbus-in-android-pt-2-sticking-your-config/" target="_blank" rel="external">http://blog.cainwong.com/using-an-eventbus-in-android-pt-2-sticking-your-config/</a><br><a href="http://blog.cainwong.com/using-an-eventbus-in-android-pt-3-threading/" target="_blank" rel="external">http://blog.cainwong.com/using-an-eventbus-in-android-pt-3-threading/</a>  </p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/15/python-module-date-time-notes/">
                Python标准库笔记之datetime
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-07-15
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Python/">Python</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/15/python-module-date-time-notes/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/15/python-module-date-time-notes/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h4 id="datetime">datetime</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line">__author__ = <span class="string">'mcxiaoke'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date, timedelta, datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常量 datetime.MINYEAR=1, datetime.MAXYEAR=9999</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">几个类方法</span><br><span class="line">datetime.date(year,month,day)</span><br><span class="line">datetime.time(hour,minute,second)</span><br><span class="line">datetime.datetime(year,month,day,hour,minute,second)</span><br><span class="line">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># date对象</span></span><br><span class="line"><span class="comment"># timedelta对象表示两个时间或日期的差值</span></span><br><span class="line">delta = timedelta(hours=-<span class="number">5</span>)</span><br><span class="line"><span class="comment"># out: datetime.timedelta(-1, 68400)</span></span><br><span class="line"><span class="keyword">print</span> delta.total_seconds()</span><br><span class="line"><span class="comment"># out: -18000.0</span></span><br><span class="line"><span class="keyword">print</span> date.today()  <span class="comment"># datetime.date(2015, 7, 4)</span></span><br><span class="line"><span class="keyword">print</span> date.fromtimestamp(time.time())  <span class="comment"># 2015-07-04</span></span><br><span class="line"></span><br><span class="line">today = date.today()</span><br><span class="line"><span class="keyword">print</span> today  <span class="comment"># 2015-07-04</span></span><br><span class="line">today == date.fromtimestamp(time.time())</span><br><span class="line"><span class="keyword">print</span> today  <span class="comment"># 2015-07-04</span></span><br><span class="line">birthday = date(today.year, <span class="number">10</span>, <span class="number">01</span>)</span><br><span class="line"><span class="keyword">print</span> birthday  <span class="comment"># 2015-10-01</span></span><br><span class="line">time_to_birthday = abs(birthday - today)</span><br><span class="line"><span class="keyword">print</span> time_to_birthday  <span class="comment"># 89 days, 0:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime对象，类方法</span></span><br><span class="line"><span class="comment"># 构造函数 datetime(year, month, day[, hour[, minute[, second[, microsecond[, tzinfo]]]]])</span></span><br><span class="line"><span class="comment"># 返回当地时间</span></span><br><span class="line">datetime.today()  <span class="comment"># datetime.datetime(2015, 7, 4, 16, 32, 29, 748628)</span></span><br><span class="line"><span class="comment"># 返回当地时间</span></span><br><span class="line">datetime.now()  <span class="comment"># datetime.datetime(2015, 7, 4, 16, 32, 53, 701843)</span></span><br><span class="line"><span class="comment"># 返回UTC时间</span></span><br><span class="line">datetime.utcnow()  <span class="comment"># datetime.datetime(2015, 7, 4, 8, 34, 14, 433219)</span></span><br><span class="line"><span class="comment"># 根据时间戳构建当地时间</span></span><br><span class="line">datetime.fromtimestamp(time.time())  <span class="comment"># datetime.datetime(2015, 7, 4, 16, 34, 53, 402597)</span></span><br><span class="line"><span class="comment"># 根据时间戳构建UTC时间</span></span><br><span class="line">datetime.utcfromtimestamp(time.time())  <span class="comment"># datetime.datetime(2015, 7, 4, 8, 35, 36, 268517)</span></span><br><span class="line"><span class="comment"># 根据格式和日期字符串构造对象，用法同time模块的strptime()</span></span><br><span class="line"><span class="comment"># datetime.strptime(date_string, format)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime对象，实例方法</span></span><br><span class="line">now = datetime.now()</span><br><span class="line"><span class="keyword">print</span> now.date()  <span class="comment"># 2015-07-04</span></span><br><span class="line"><span class="keyword">print</span> now.time()  <span class="comment"># 16:45:29.077727</span></span><br><span class="line"><span class="keyword">print</span> now.utcoffset()  <span class="comment"># None</span></span><br><span class="line"><span class="keyword">print</span> now.timetuple()</span><br><span class="line"><span class="comment"># out: time.struct_time(tm_year=2015, tm_mon=7, tm_mday=4,</span></span><br><span class="line"><span class="comment"># tm_hour=16, tm_min=46, tm_sec=29, tm_wday=5, tm_yday=185, tm_isdst=-1)</span></span><br><span class="line"><span class="comment"># 类似的还有 now.utctimetuple()</span></span><br><span class="line"><span class="keyword">print</span> now.__str__()  <span class="comment"># 2015-07-04 16:48:02.930730</span></span><br><span class="line"><span class="keyword">print</span> now.ctime()  <span class="comment"># 'Sat Jul  4 16:44:03 2015'</span></span><br><span class="line"><span class="keyword">print</span> now.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)  <span class="comment"># 2015-07-04 16:49:25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># time对象</span></span><br><span class="line">t = now.time()</span><br><span class="line"><span class="keyword">print</span> t.isoformat()  <span class="comment"># 返回ISO8601格式 16:52:19.700394</span></span><br><span class="line"><span class="keyword">print</span> t.utcoffset()  <span class="comment"># 返回时区偏移 None</span></span><br></pre></td></tr></table></figure>
<h4 id="time">time</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line">__author__ = <span class="string">'mcxiaoke'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关模块 datetime,calendar, locale</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 时区缩写表示</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">GMT 格林威治标准时间 Greenwich Mean Time</span><br><span class="line">UTC 协调世界时 Coordinated Universal Time</span><br><span class="line">CST 可同时代表以下四个：</span><br><span class="line">Central Standard Time (USA) UT-6:00</span><br><span class="line">Central Standard Time (Australia) UT+9:30</span><br><span class="line">China Standard Time UT+8:00</span><br><span class="line">Cuba Standard Time UT-4:00</span><br><span class="line">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Unix时间起点是1970年1月1号0点，终点是2038年</span></span><br><span class="line">time.gmtime(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># out: time.struct_time(tm_year=1970, tm_mon=1, tm_mday=1, tm_hour=0,</span></span><br><span class="line"><span class="comment"># tm_min=0, tm_sec=0, tm_wday=3, tm_yday=1, tm_isdst=0)</span></span><br><span class="line"><span class="comment"># UTC=GMT 两种叫法而已</span></span><br><span class="line"><span class="comment"># 返回当前的时间戳</span></span><br><span class="line">time.time()  <span class="comment"># out: 1435994390.769246</span></span><br><span class="line"><span class="comment"># 返回当前UTC/GMT时间，结果为 struct_time</span></span><br><span class="line">time.gmtime()</span><br><span class="line"><span class="comment"># out: time.struct_time(tm_year=2015, tm_mon=7, tm_mday=4, tm_hour=7,</span></span><br><span class="line"><span class="comment"># tm_min=20, tm_sec=35, tm_wday=5, tm_yday=185, tm_isdst=0)</span></span><br><span class="line"><span class="comment"># 返回当前时区的时间，结果为 struct_time</span></span><br><span class="line">time.localtime()</span><br><span class="line"><span class="comment"># out: time.struct_time(tm_year=2015, tm_mon=7, tm_mday=4, tm_hour=15,</span></span><br><span class="line"><span class="comment"># tm_min=21, tm_sec=30, tm_wday=5, tm_yday=185, tm_isdst=0)</span></span><br><span class="line"></span><br><span class="line">time.mktime(time.localtime())  <span class="comment"># 转换成时间戳</span></span><br><span class="line">time.asctime(time.localtime())  <span class="comment"># 转换成字符串</span></span><br><span class="line"><span class="comment"># out: 'Sat Jul  4 15:24:18 2015'</span></span><br><span class="line">time.asctime()  <span class="comment"># 默认使用 localtime()</span></span><br><span class="line">time.ctime()  <span class="comment"># 字符串表示的当地时间</span></span><br><span class="line"><span class="comment"># ctime(secs) = asctime(localtime(secs))</span></span><br><span class="line"><span class="comment"># ctime.sleep(seconds)  # 挂起当前线程一段时间，单位为秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间字符串格式化</span></span><br><span class="line"><span class="comment"># time.strftime(format[,t]) 格式化struct_time，默认是当前时间</span></span><br><span class="line"><span class="comment"># 转换成unicode编码 strftime(&lt;myformat&gt;).decode(locale.getlocale()</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"当前时间戳"</span>, time.time()</span><br><span class="line">time_text = time.strftime(</span><br><span class="line">    <span class="string">'%%A    (%A)    #当地星期几缩写\n '</span></span><br><span class="line">    <span class="string">'%%a    (%a)    #当地星期几全称\n '</span></span><br><span class="line">    <span class="string">'%%B    (%B)    #当地月份全称\n '</span></span><br><span class="line">    <span class="string">'%%b    (%b)    #当地月份缩写\n '</span></span><br><span class="line">    <span class="string">'%%c    (%c)    #当地日期和时间表示\n '</span></span><br><span class="line">    <span class="string">'%%d    (%d)    #代表日期天数的数字[01,31]\n '</span></span><br><span class="line">    <span class="string">'%%H    (%H)    #24小时制的小时数[00,23]\n '</span></span><br><span class="line">    <span class="string">'%%I    (%I)    #12小时制的小时数[01,12]\n '</span></span><br><span class="line">    <span class="string">'%%j    (%j)    #一年中的第几天[001,366]\n '</span></span><br><span class="line">    <span class="string">'%%m    (%m)    #代表日期月份的数字[01,12]\n '</span></span><br><span class="line">    <span class="string">'%%M    (%M)    #代表时间分钟的数字[00,59]\n '</span></span><br><span class="line">    <span class="string">'%%p    (%p)    #当地表示上午/下午的缩写，如AM/PM\n '</span></span><br><span class="line">    <span class="string">'%%S    (%S)    #代表时间秒数的数字[00,61]\n '</span></span><br><span class="line">    <span class="string">'%%U    (%U)    #一年中的第几周[00,53](星期日作为一周的开始)\n '</span></span><br><span class="line">    <span class="string">'%%w    (%w)    #代表日期星期几的数字[0(星期一),6]\n '</span></span><br><span class="line">    <span class="string">'%%W    (%W)    #一年中的第几周[00,53](星期一作为一周的开始)\n '</span></span><br><span class="line">    <span class="string">'%%x    (%x)    #当地的日期表示\n '</span></span><br><span class="line">    <span class="string">'%%X    (%X)    #当地的时间表示\n '</span></span><br><span class="line">    <span class="string">'%%y    (%y)    #二位数的年份表示\n '</span></span><br><span class="line">    <span class="string">'%%Y    (%Y)    #四位数的年份表示\n '</span></span><br><span class="line">    <span class="string">'%%Z    (%Z)    #当前时区表示\n '</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"当前时间结构"</span>, time.localtime()</span><br><span class="line"><span class="keyword">print</span> <span class="string">"时间格式举例"</span>, time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line"><span class="keyword">print</span> time_text</span><br><span class="line"><span class="comment"># 输出的表示</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">当前时间戳 1435997058.36</span><br><span class="line">当前时间结构 time.struct_time(tm_year=2015, tm_mon=7, tm_mday=4,</span><br><span class="line">tm_hour=16, tm_min=4, tm_sec=18, tm_wday=5, tm_yday=185, tm_isdst=0)</span><br><span class="line">时间格式举例 2015-07-04 16:04:18</span><br><span class="line">%A    (Saturday)    #当地星期几缩写</span><br><span class="line"> %a    (Sat)    #当地星期几全称</span><br><span class="line"> %B    (July)    #当地月份全称</span><br><span class="line"> %b    (Jul)    #当地月份缩写</span><br><span class="line"> %c    (Sat Jul  4 16:04:18 2015)    #当地日期和时间表示</span><br><span class="line"> %d    (04)    #代表日期天数的数字[01,31]</span><br><span class="line"> %H    (16)    #24小时制的小时数[00,23]</span><br><span class="line"> %I    (04)    #12小时制的小时数[01,12]</span><br><span class="line"> %j    (185)    #一年中的第几天[001,366]</span><br><span class="line"> %m    (07)    #代表日期月份的数字[01,12]</span><br><span class="line"> %M    (04)    #代表时间分钟的数字[00,59]</span><br><span class="line"> %p    (PM)    #当地表示上午/下午的缩写，如AM/PM</span><br><span class="line"> %S    (18)    #代表时间秒数的数字[00,61]</span><br><span class="line"> %U    (26)    #一年中的第几周[00,53](星期日作为一周的开始)</span><br><span class="line"> %w    (6)    #代表日期星期几的数字[0(星期一),6]</span><br><span class="line"> %W    (26)    #一年中的第几周[00,53](星期一作为一周的开始)</span><br><span class="line"> %x    (07/04/15)    #当地的日期表示</span><br><span class="line"> %X    (16:04:18)    #当地的时间表示</span><br><span class="line"> %y    (15)    #二位数的年份表示</span><br><span class="line"> %Y    (2015)    #四位数的年份表示</span><br><span class="line"> %Z    (CST)    #当前时区表示</span><br><span class="line">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按格式解析时间，返回值为 struct_time</span></span><br><span class="line">time.strptime(<span class="string">'2005-09-01 9:45:20'</span>, <span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line"><span class="comment"># out: time.struct_time(tm_year=2005, tm_mon=9, tm_mday=1,</span></span><br><span class="line"><span class="comment"># tm_hour=9, tm_min=45, tm_sec=20, tm_wday=3, tm_yday=244, tm_isdst=-1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># struct_time结构说明</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">0   tm_year (for example, 1993)</span><br><span class="line">1   tm_mon  取值范围 [1, 12]</span><br><span class="line">2   tm_mday 取值范围 [1, 31]</span><br><span class="line">3   tm_hour 取值范围 [0, 23]</span><br><span class="line">4   tm_min  取值范围 [0, 59]</span><br><span class="line">5   tm_sec  取值范围 [0, 61]</span><br><span class="line">6   tm_wday 取值范围 [0, 6] # 星期一=0</span><br><span class="line">7   tm_yday 取值范围 [1, 366]</span><br><span class="line">8   tm_isdst 取值范围 0, 1 or -1</span><br><span class="line">'''</span></span><br></pre></td></tr></table></figure>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/15/python-module-string-notes/">
                Python标准库笔记之string
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-07-15
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Python/">Python</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/15/python-module-string-notes/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/15/python-module-string-notes/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h4 id="String">String</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="comment"># Created by mcxiaoke on 15/7/4 17:01.</span></span><br><span class="line">__author__ = <span class="string">'mcxiaoke'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> Template</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一些常量</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">whitespace = ' \t\n\r\v\f'</span><br><span class="line">lowercase = 'abcdefghijklmnopqrstuvwxyz'</span><br><span class="line">uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><br><span class="line">letters = lowercase + uppercase</span><br><span class="line">ascii_lowercase = lowercase</span><br><span class="line">ascii_uppercase = uppercase</span><br><span class="line">ascii_letters = ascii_lowercase + ascii_uppercase</span><br><span class="line">digits = '0123456789'</span><br><span class="line">hexdigits = digits + 'abcdef' + 'ABCDEF'</span><br><span class="line">octdigits = '01234567'</span><br><span class="line">punctuation = """!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`&#123;|&#125;~"""</span><br><span class="line">printable = digits + letters + punctuation + whitespace</span><br><span class="line">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串格式化</span></span><br><span class="line"><span class="comment"># 字符串格式化格式为 "hello, world &#123;0&#125; &#123;1&#125;"</span></span><br><span class="line"><span class="comment"># 默认调用 __format()__方法，可以显示使用str()或repr()</span></span><br><span class="line"><span class="comment"># "Harold's a clever &#123;0!s&#125;"        # Calls str() on the argument first</span></span><br><span class="line"><span class="comment"># "Bring out the holy &#123;name!r&#125;"    # Calls repr() on the argument first</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"hello, world &#123;0&#125; &#123;1&#125; !"</span>.format(<span class="string">'first'</span>, <span class="string">'second'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串格式 %s</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Welcome to %s"</span> % <span class="string">"China"</span></span><br><span class="line"><span class="comment"># 命名参数</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'I love %(cat)s and %(dog)s.'</span> % &#123;<span class="string">'cat'</span>: <span class="string">'BadCat'</span>, <span class="string">'dog'</span>: <span class="string">'BadDog'</span>&#125;</span><br><span class="line"><span class="comment"># out:I love BadCat and BadDog.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 整数格式</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">'b' 二进制整数</span><br><span class="line">'c' Unicode字符</span><br><span class="line">'d' 十进制整数</span><br><span class="line">'o' 八进制整数</span><br><span class="line">'x' 十六进制，小写</span><br><span class="line">'X' 十六进制，大写</span><br><span class="line">'n' 十进制，带分隔符</span><br><span class="line">'''</span></span><br><span class="line">num = <span class="number">1234567890</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"十进制:%d 八进制:%o 十六进制:0x%x 十六进制:0X%X"</span> % (num, num, num, num)</span><br><span class="line"><span class="comment"># out: 十进制:1234567890 八进制:11145401322 十六进制:0x499602d2 十六进制:0X499602D2</span></span><br><span class="line"><span class="comment"># 浮点数格式</span></span><br><span class="line">fnum = <span class="number">987123456.78901234567890123</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'%e'</span> % fnum, <span class="string">'%E'</span> % fnum, <span class="string">'%f'</span> % fnum, <span class="string">'%F'</span> % fnum, <span class="string">'%g'</span> % fnum, <span class="string">'%G'</span> % fnum</span><br><span class="line"><span class="comment"># out: 9.871235e+08 9.871235E+08 987123456.789012 987123456.789012 9.87123e+08 9.87123E+08</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化例子</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;0&#125;, &#123;1&#125;, &#123;2&#125;'</span>.format(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)  <span class="comment"># a, b, c</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;&#125;, &#123;&#125;, &#123;&#125;'</span>.format(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)  <span class="comment"># a, b, c</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;2&#125;, &#123;1&#125;, &#123;0&#125;'</span>.format(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)  <span class="comment"># c, b, a</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;2&#125;, &#123;1&#125;, &#123;0&#125;'</span>.format(*<span class="string">'abc'</span>)  <span class="comment"># 参数解包</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;0&#125;&#123;1&#125;&#123;0&#125;'</span>.format(<span class="string">'hello-'</span>, <span class="string">'world-'</span>)  <span class="comment"># 参数可以重复使用</span></span><br><span class="line"><span class="comment"># out: hello-world-hello-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 命名参数例子 # out: 经纬度: (37.24N, -115.81W)</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'经纬度: (&#123;0&#125;, &#123;1&#125;)'</span>.format(<span class="string">'37.24N'</span>, <span class="string">'-115.81W'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'A 经纬度: (&#123;latitude&#125;, &#123;longitude&#125;)'</span>.format(latitude=<span class="string">'37.24N'</span>, longitude=<span class="string">'-115.81W'</span>)</span><br><span class="line">args = (<span class="string">'37.24N'</span>, <span class="string">'-115.81W'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'B 经纬度: (&#123;&#125;, &#123;&#125;)'</span>.format(*args)</span><br><span class="line">kwargs = &#123;<span class="string">'latitude'</span>: <span class="string">'37.24N'</span>, <span class="string">'longitude'</span>: <span class="string">'-115.81W'</span>&#125;</span><br><span class="line"><span class="keyword">print</span> <span class="string">'C 经纬度: (&#123;latitude&#125;, &#123;longitude&#125;)'</span>.format(**kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义对象例子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x, self.y = x, y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Point(&#123;self.x&#125;,&#123;self.y&#125;)"</span>.format(self=self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"(x=&#123;self.x&#125;,y=&#123;self.y&#125;)"</span>.format(self=self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pt = Point(<span class="number">15</span>, <span class="number">238</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Point is &#123;&#125;'</span>.format(pt)  <span class="comment"># Point is Point(15,238)</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Point(x=&#123;0.x&#125;, y=&#123;0.y&#125;)'</span>.format(pt)  <span class="comment"># Point(x=15, y=238)</span></span><br><span class="line">two = (<span class="string">'hello'</span>, <span class="string">'world'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'A=&#123;0[0]&#125;, B=&#123;0[1]&#125;'</span>.format(two)  <span class="comment"># A=hello, B=world</span></span><br><span class="line"><span class="comment"># 使用 repr()和str()的示例</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"repr() shows quotes: &#123;!r&#125;; str() doesn't: &#123;!s&#125;"</span>.format(<span class="string">'test1'</span>, <span class="string">'test2'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Point is &#123;0!r&#125; &#123;0!s&#125;'</span>.format(pt)  <span class="comment"># Point is (x=15,y=238) Point(15,238)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对其方式</span></span><br><span class="line"><span class="comment"># 星号用于加强显示效果，默认是空白</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:*&lt;30&#125;'</span>.format(<span class="string">'左对齐'</span>)  <span class="comment"># 左对齐*********************</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:*&gt;30&#125;'</span>.format(<span class="string">'右对齐'</span>)  <span class="comment"># *********************右对齐</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:*^30&#125;'</span>.format(<span class="string">'居中对其'</span>)  <span class="comment"># *********居中对其*********</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数字格式处理</span></span><br><span class="line"><span class="comment"># 不带前缀</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"int: &#123;0:d&#125;;  hex: &#123;0:x&#125;;  oct: &#123;0:o&#125;;  bin: &#123;0:b&#125;"</span>.format(<span class="number">2015</span>)</span><br><span class="line"><span class="comment"># out: int: 2015;  hex: 7df;  oct: 3737;  bin: 11111011111</span></span><br><span class="line"><span class="comment"># 带前缀</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"int: &#123;0:d&#125;;  hex: &#123;0:#x&#125;;  oct: &#123;0:#o&#125;;  bin: &#123;0:#b&#125;"</span>.format(<span class="number">2015</span>)</span><br><span class="line"><span class="comment"># int: 2015;  hex: 0x7df;  oct: 0o3737;  bin: 0b11111011111</span></span><br><span class="line"><span class="comment"># 添加分隔符</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:,&#125;'</span>.format(<span class="number">1234567890</span>)  <span class="comment"># 1,234,567,890</span></span><br><span class="line"><span class="comment"># 日期时间格式化</span></span><br><span class="line">d = datetime.datetime.now()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:%Y-%m-%d %H:%M:%S&#125;'</span>.format(d)  <span class="comment"># 2015-07-04 18:34:28</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串模板</span></span><br><span class="line">s = Template(<span class="string">'$who likes to eat $what'</span>)</span><br><span class="line"><span class="keyword">print</span> s.substitute(who=<span class="string">'john'</span>, what=<span class="string">'fish'</span>)  <span class="comment"># john likes to eat fish</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串函数</span></span><br><span class="line">s = <span class="string">'this is some sample text.'</span></span><br><span class="line"><span class="comment"># 首字母大写</span></span><br><span class="line"><span class="keyword">print</span> string.capitalize(s)  <span class="comment"># This is some sample text.</span></span><br><span class="line"><span class="comment"># 结果等于 s.capitalize()</span></span><br><span class="line"><span class="comment"># 查找字符串</span></span><br><span class="line"><span class="keyword">print</span> s.find(<span class="string">'is'</span>)  <span class="comment"># 2</span></span><br><span class="line"><span class="keyword">print</span> s.find(<span class="string">'hello'</span>)  <span class="comment"># -1</span></span><br><span class="line"><span class="comment"># 分割字符串</span></span><br><span class="line"><span class="keyword">print</span> s.split(<span class="string">' '</span>)  <span class="comment"># ['this', 'is', 'some', 'sample', 'text.']</span></span><br><span class="line"><span class="keyword">print</span> s.split(<span class="string">' '</span>, <span class="number">1</span>)  <span class="comment"># ['this', 'is some sample text.']</span></span><br><span class="line"><span class="keyword">print</span> s.rsplit(<span class="string">' '</span>, <span class="number">1</span>)  <span class="comment"># ['this is some sample', 'text.']</span></span><br><span class="line"><span class="comment"># 合并字符串</span></span><br><span class="line"><span class="keyword">print</span> s.join([<span class="string">'A_'</span>, <span class="string">'B'</span>])  <span class="comment"># A_this is some sample text.B</span></span><br><span class="line"><span class="keyword">print</span> string.join([<span class="string">'there'</span>, <span class="string">'are'</span>, <span class="string">'joined'</span>, <span class="string">'words'</span>], <span class="string">' '</span>)  <span class="comment"># there are joined words</span></span><br><span class="line">s2 = <span class="string">'this\tis\tsome\tsample\ttext'</span></span><br><span class="line"><span class="comment"># 展开TAB</span></span><br><span class="line"><span class="keyword">print</span> s2.expandtabs(<span class="number">4</span>)  <span class="comment"># this    is  some    sample  text</span></span><br><span class="line">s3 = <span class="string">'     hello,     python!    '</span></span><br><span class="line"><span class="comment"># 检查结尾</span></span><br><span class="line"><span class="keyword">print</span> s.endswith(<span class="string">'hello'</span>)  <span class="comment"># out:False</span></span><br><span class="line"><span class="comment"># 去除前后空白</span></span><br><span class="line"><span class="keyword">print</span> s3.strip()  <span class="comment"># hello,     python!</span></span><br><span class="line">s4 = <span class="string">'THIS is SOME text.'</span></span><br><span class="line"><span class="comment"># 交换大小写</span></span><br><span class="line"><span class="keyword">print</span> s4.swapcase()  <span class="comment"># this IS some TEXT.</span></span><br><span class="line"><span class="comment"># 首字母大写</span></span><br><span class="line"><span class="keyword">print</span> s4.capitalize()  <span class="comment"># This is some text.</span></span><br><span class="line"><span class="comment"># 标题模式，单词首字母大写</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'title:'</span>, s4.title()  <span class="comment"># This Is Some Text.</span></span><br><span class="line"><span class="comment"># 全部小写</span></span><br><span class="line"><span class="keyword">print</span> s4.lower()  <span class="comment"># this is some text.</span></span><br><span class="line"><span class="comment"># 全部大写</span></span><br><span class="line"><span class="keyword">print</span> s4.upper()  <span class="comment"># THIS IS SOME TEXT.</span></span><br><span class="line"><span class="comment"># 全是字母和数字</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'12345678abcdefg'</span>.isalnum()  <span class="comment"># out:True</span></span><br><span class="line"><span class="comment"># 全是数字</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'12345'</span>.isdigit()  <span class="comment"># out:True</span></span><br><span class="line"><span class="comment"># 全是字母</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'12345, hello'</span>.isalpha()  <span class="comment"># out:False</span></span><br><span class="line"><span class="comment"># 删除指定字符</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'hello,world,I love cats'</span>.translate(<span class="keyword">None</span>, <span class="string">'o'</span>)  <span class="comment"># out:hell,wrld,I lve cats</span></span><br><span class="line"><span class="comment"># 补齐字符串</span></span><br><span class="line"><span class="keyword">print</span> s4.ljust(<span class="number">30</span>, <span class="string">'_'</span>)  <span class="comment"># THIS is SOME text.____________</span></span><br><span class="line"><span class="keyword">print</span> s4.rjust(<span class="number">30</span>, <span class="string">'_'</span>)  <span class="comment"># ____________THIS is SOME text.</span></span><br><span class="line"><span class="keyword">print</span> s4.center(<span class="number">30</span>, <span class="string">'_'</span>)  <span class="comment"># ______THIS is SOME text.______</span></span><br><span class="line"><span class="keyword">print</span> s4.zfill(<span class="number">30</span>)  <span class="comment"># 000000000000THIS is SOME text.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换字符串</span></span><br><span class="line">s5 = <span class="string">'color1 and color2 and color3 scheme files are tested.'</span></span><br><span class="line"><span class="keyword">print</span> s5.replace(<span class="string">'color'</span>, <span class="string">'dark'</span>)</span><br><span class="line"><span class="comment"># out: dark1 and dark2 and dark3 scheme files are tested.</span></span><br><span class="line"><span class="keyword">print</span> s5.replace(<span class="string">'and'</span>, <span class="string">''</span>)</span><br><span class="line"><span class="comment"># out: color1  color2  color3 scheme files are tested.</span></span><br><span class="line"><span class="keyword">print</span> s5.replace(<span class="string">' '</span>, <span class="string">'_'</span>)</span><br><span class="line"><span class="comment"># out: color1_and_color2_and_color3_scheme_files_are_tested.</span></span><br><span class="line"><span class="keyword">print</span> s5.replace(<span class="string">' '</span>, <span class="string">'-'</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># out: color1-and-color2 and color3 scheme files are tested.</span></span><br></pre></td></tr></table></figure>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/15/python-image-exif-rename/">
                根据EXIF拍摄时间批量重命名照片
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-07-15
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Python/">Python</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/15/python-image-exif-rename/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/15/python-image-exif-rename/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="根据EXIF拍摄时间批量重命名照片">根据EXIF拍摄时间批量重命名照片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: mcxiaoke</span></span><br><span class="line"><span class="comment"># @Date:   2015-07-10 08:24:23</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> exifread</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">TAGS = [</span><br><span class="line">    <span class="string">'GPS GPSLatitude'</span>,</span><br><span class="line">    <span class="string">'GPS GPSLongitude'</span>,</span><br><span class="line">    <span class="string">'GPS GPSDate'</span>,</span><br><span class="line">    <span class="string">'GPS GPSImgDirection'</span>,</span><br><span class="line">    <span class="string">'Image DateTime'</span>,</span><br><span class="line">    <span class="string">'Image Orientation'</span>,</span><br><span class="line">    <span class="string">'Image Software'</span>,</span><br><span class="line">    <span class="string">'Image Model'</span>,</span><br><span class="line">    <span class="string">'Image Make'</span>,</span><br><span class="line">    <span class="string">'Image XResolution'</span>,</span><br><span class="line">    <span class="string">'Image YResolution'</span>,</span><br><span class="line">    <span class="string">'EXIF ExifVersion'</span>,</span><br><span class="line">    <span class="string">'EXIF ExifImageLength'</span>,</span><br><span class="line">    <span class="string">'EXIF ExifImageWidth'</span>,</span><br><span class="line">    <span class="string">'EXIF LensMake'</span>,</span><br><span class="line">    <span class="string">'EXIF LensModel'</span>,</span><br><span class="line">    <span class="string">'EXIF FocalLength'</span>,</span><br><span class="line">    <span class="string">'EXIF WhiteBalance'</span>,</span><br><span class="line">    <span class="string">'EXIF ISOSpeedRatings'</span>,</span><br><span class="line">    <span class="string">'EXIF ExposureMode'</span>,</span><br><span class="line">    <span class="string">'EXIF ExposureTime'</span>,</span><br><span class="line">    <span class="string">'EXIF ExposureProgram'</span>,</span><br><span class="line">    <span class="string">'EXIF DateTimeOriginal'</span>,</span><br><span class="line">    <span class="string">'EXIF DateTimeDigitized'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">NAME_TAGS = [</span><br><span class="line">    <span class="string">'GPS GPSDate'</span>,</span><br><span class="line">    <span class="string">'Image DateTime'</span>,</span><br><span class="line">    <span class="string">'Image Model'</span>,</span><br><span class="line">    <span class="string">'Image XResolution'</span>,</span><br><span class="line">    <span class="string">'Image YResolution'</span>,</span><br><span class="line">    <span class="string">'EXIF ExifImageLength'</span>,</span><br><span class="line">    <span class="string">'EXIF ExifImageWidth'</span>,</span><br><span class="line">    <span class="string">'EXIF ISOSpeedRatings'</span>,</span><br><span class="line">    <span class="string">'EXIF DateTimeOriginal'</span>,</span><br><span class="line">    <span class="string">'EXIF DateTimeDigitized'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">EXIF_DATE_TIME = <span class="string">'%Y:%m:%d %H:%M:%S'</span></span><br><span class="line">NAME_DATE_TIME = <span class="string">'IMG_%Y%m%d_%H%M%S'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageInfo</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, path, width, height, time=None, iso=<span class="number">0</span>, model=None)</span>:</span></span><br><span class="line">        self.path = path</span><br><span class="line">        self.width = width</span><br><span class="line">        self.height = height</span><br><span class="line">        self.time = time</span><br><span class="line">        self.iso = iso</span><br><span class="line">        self.model = model</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        time_str = datetime.strftime(</span><br><span class="line">            self.time, EXIF_DATE_TIME) <span class="keyword">if</span> self.time <span class="keyword">else</span> <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Image&#123;path=%s,width=%s,height=%s,time=%s,iso=%s,model=%s&#125;'</span> % (</span><br><span class="line">            self.path, self.width, self.height,</span><br><span class="line">            time_str, self.iso, self.model)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Usage: python %s some_directory'</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">top = unicode(path.normcase(sys.argv[<span class="number">1</span>]))</span><br><span class="line">log = codecs.open(path.join(top, <span class="string">'log.txt'</span>), <span class="string">'w'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(top):</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> files:</span><br><span class="line">        _, ext = path.splitext(name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ext <span class="keyword">or</span> ext.lower() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'.jpg'</span>, <span class="string">'.png'</span>]:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        rel_path = path.join(root, name)</span><br><span class="line">        src_path = path.abspath(rel_path)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"process file:"</span>, src_path</span><br><span class="line">        f = open(path.join(root, name), <span class="string">'rb'</span>)</span><br><span class="line">        tags = exifread.process_file(f)</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tags:</span><br><span class="line">            log.write(<span class="string">'No exif tags found for: %s\n'</span> % rel_path)</span><br><span class="line">        <span class="string">'''</span><br><span class="line">        img_path = src_path</span><br><span class="line">        width_str = str(tags.get('EXIF ExifImageWidth'))</span><br><span class="line">        height_str = str(tags.get('EXIF ExifImageLength'))</span><br><span class="line">        img_w = int(width_str) if width_str and width_str.isdigit() else 0</span><br><span class="line">        img_h = int(height_str) if height_str and height_str.isdigit() else 0</span><br><span class="line">        time_str = str(tags.get('Image DateTime'))</span><br><span class="line">        img_time = datetime.strptime(</span><br><span class="line">            time_str, EXIF_DATE_TIME) if time_str else None</span><br><span class="line">        iso_str = str(tags.get('EXIF ISOSpeedRatings'))</span><br><span class="line">        print 'iso_str=%s' % iso_str</span><br><span class="line">        img_iso = int(iso_str) if iso_str and iso_str.isdigit() else 0</span><br><span class="line">        img_model = str(tags.get('Image Model'))</span><br><span class="line">        img = ImageInfo(img_path, img_w, img_h, time=img_time,</span><br><span class="line">                        iso=img_iso, model=img_model)</span><br><span class="line">        '''</span></span><br><span class="line">        time_str = str(tags.get(<span class="string">'Image DateTime'</span>)) <span class="keyword">if</span> tags <span class="keyword">else</span> <span class="keyword">None</span></span><br><span class="line">        img_time = datetime.strptime(</span><br><span class="line">            time_str, EXIF_DATE_TIME) <span class="keyword">if</span> time_str <span class="keyword">else</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> img_time:</span><br><span class="line">            os.stat(src_path)</span><br><span class="line">            img_time = datetime.fromtimestamp(os.stat(src_path).st_mtime)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'no exif, using last modified time for %s'</span> % name</span><br><span class="line">            log.write(<span class="string">'using stat modify time for %s\n'</span> % name)</span><br><span class="line">        dst_path = path.join(</span><br><span class="line">            root, datetime.strftime(img_time, NAME_DATE_TIME)+ext.lower())</span><br><span class="line">        <span class="keyword">if</span> path.exists(dst_path):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'dst file exists, no need to rename, skip %s'</span> % name</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        os.rename(src_path, dst_path)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'renamed to'</span>, dst_path</span><br><span class="line">        log.flush()</span><br><span class="line"></span><br><span class="line">log.close()</span><br></pre></td></tr></table></figure>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/06/30/vps-nginx-php5-fpm-config/">
                在VPS上配置Nginx和PHP
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2014-06-30
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Web/">Web</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/06/30/vps-nginx-php5-fpm-config/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/06/30/vps-nginx-php5-fpm-config/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>之前买了一个廉价VPS，系统是Ubuntu 12.04，一直没有用上，最近装上Nginx和PHP，下面就是配置记录。</p>
<p>首先当然是安装各种必备的工具：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">sudo</span> apt-<span class="preprocessor">get</span> install php5-<span class="preprocessor">common</span> php5-cli php5-fpm</span><br><span class="line"><span class="label">sudo</span> apt-<span class="preprocessor">get</span> install nginx</span><br></pre></td></tr></table></figure>
<p>下面是nginx的配置文件，位置是 <code>/etc/nginx/sites-available/mcxiaoke.com</code></p>
<p>这里假设我的域名是 <code>mcxiaoke.com</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置HTTP站点</span></span><br><span class="line"><span class="title">server</span> &#123;</span><br><span class="line"><span class="title">listen</span> <span class="number">80</span>;</span><br><span class="line"><span class="comment"># 站点根目录</span></span><br><span class="line"><span class="title">root</span> /var/www/;</span><br><span class="line"></span><br><span class="line"><span class="title">index</span> index.php index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line"><span class="title">server_name</span> mcxiaoke.com;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向所有HTTP到HTTPS</span></span><br><span class="line"><span class="title">rewrite</span><span class="regexp"> ^(.*)$</span> <span class="url">https://<span class="variable">$host</span><span class="variable">$1</span></span> <span class="built_in">permanent</span>;</span><br><span class="line"></span><br><span class="line"><span class="title">location</span> / &#123;</span><br><span class="line"><span class="title">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php<span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line"></span><br><span class="line"><span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="title">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"><span class="title">location</span> = /50x.html &#123;</span><br><span class="line"><span class="title">root</span> /usr/share/nginx/www;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置PHP</span></span><br><span class="line"><span class="title">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line"><span class="title">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line"><span class="title">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line"><span class="title">include</span> fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置HTTPS站点</span></span><br><span class="line"><span class="title">server</span> &#123;</span><br><span class="line"><span class="title">listen</span> <span class="number">443</span>;</span><br><span class="line"><span class="title">server_name</span> mcxiaoke.com;</span><br><span class="line"><span class="comment">#站点根目录</span></span><br><span class="line"><span class="title">root</span> /var/www/;</span><br><span class="line"><span class="title">index</span> index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line"><span class="title">ssl</span> <span class="built_in">on</span>;</span><br><span class="line"><span class="comment"># 这里是网站的SSL证书</span></span><br><span class="line"><span class="title">ssl_certificate</span> /etc/nginx/ssl/ssl.crt;</span><br><span class="line"><span class="title">ssl_certificate_key</span> /etc/nginx/ssl/ssl.key;</span><br><span class="line"></span><br><span class="line"><span class="title">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line"><span class="title">ssl_ciphers</span> RC4:HIGH:!aNULL:!MD5;</span><br><span class="line"><span class="title">ssl_prefer_server_ciphers</span> <span class="built_in">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ssl_protocols SSLv3 TLSv1;</span></span><br><span class="line"><span class="comment">#ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;</span></span><br><span class="line"><span class="comment">#ssl_prefer_server_ciphers on;</span></span><br><span class="line"></span><br><span class="line"><span class="title">location</span> / &#123;</span><br><span class="line"><span class="title">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php<span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line"></span><br><span class="line"><span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="title">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"><span class="title">location</span> = /50x.html &#123;</span><br><span class="line"><span class="title">root</span> /usr/share/nginx/www;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置PHP</span></span><br><span class="line"><span class="title">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line"><span class="title">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line"><span class="title">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line"><span class="title">include</span> fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好之后可以在某个目录下放一个info.php文件，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> phpinfo(); <span class="preprocessor">?&gt;</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后重启服务：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">service</span> php5-fpm <span class="literal">restart</span></span><br><span class="line">sudo <span class="keyword">service</span> nginx <span class="literal">restart</span></span><br></pre></td></tr></table></figure>
<p>如果能正常访问，能看到服务器的PHP配置信息，就表明配置没有问题。</p>
<p>参考文章：<br><a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-on-ubuntu-14-04" target="_blank" rel="external">How To Install LEMP stack on Ubuntu 14.04</a><br><a href="http://askubuntu.com/questions/134666/what-is-the-easiest-way-to-enable-php-on-nginx" target="_blank" rel="external">Mac OSX 10.9搭建nginx+mysql+php-fpm环境</a></p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/06/30/android-dev-notes-03/">
                Android开发杂记（三）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2014-06-30
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android/">Android</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/06/30/android-dev-notes-03/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/06/30/android-dev-notes-03/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>这是另一部分的Android开发笔记整理</p>
<h3 id="如何完全不显示一个Activity的UI">如何完全不显示一个Activity的UI</h3><p>可以使用 <code>android:theme=&quot;@android:style/Theme.NoDisplay&quot;</code> 但是有一个注意事项，见<br><a href="http://stackoverflow.com/questions/4551868/how-to-completely-get-rid-of-an-activitys-gui-avoid-a-black-screen" target="_blank" rel="external">how to completely get rid of an activity’s GUI</a></p>
<h3 id="如何移除ActionBar底部的阴影">如何移除ActionBar底部的阴影</h3><p>自定义ActionBar的Style，使用 <code>&lt;item name=&quot;android:windowContentOverlay&quot;&gt;@null&lt;/item&gt;</code> 如果是使用ActionBarSherlock或ActionBarCompat，还需要添加 <code>&lt;item name=&quot;windowContentOverlay&quot;&gt;@null&lt;/item&gt;</code>，参考：<a href="http://stackoverflow.com/questions/11448679/how-can-i-have-a-drop-shadow-on-my-actionbar-actionbarsherlock" target="_blank" rel="external">How can I have a drop shadow on my ActionBar</a></p>
<h3 id="使用Gradle时私密存储签名密钥">使用Gradle时私密存储签名密钥</h3><p>参考这个Gist：<a href="https://gist.github.com/mcxiaoke/8450376" target="_blank" rel="external">build.gradle</a></p>
<h3 id="透明的Activity退出后，没有真正finish的问题">透明的Activity退出后，没有真正finish的问题</h3><p>具体见 <a href="http://blog.sina.com.cn/s/blog_601cbd070100npf8.html" target="_blank" rel="external">这里的分析</a><br>android:windowShowWallpaper = true的作用，这并不是在后面显示桌面，是配置Activity的背景为桌面背景</p>
<h3 id="Background和Seletor必须使用真实的Drawable">Background和Seletor必须使用真实的Drawable</h3><p>否则，有些三星和摩托的机子上会没有背景，显示纯黑色，定义在colors.xml里的伪drawble不行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">color</span> <span class="attribute">name</span>=<span class="value">"mail_published_time_color"</span>&gt;</span>#bcbcbc<span class="tag">&lt;/<span class="title">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">drawable</span> <span class="attribute">name</span>=<span class="value">"ab_bg_black"</span>&gt;</span>#aa191919<span class="tag">&lt;/<span class="title">drawable</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>必须是真实的图片drawable或者定义好的shape</p>
<h3 id="合并多个git仓库，保留commit记录的方法">合并多个git仓库，保留commit记录的方法</h3><p>详情见<a href="http://stackoverflow.com/questions/1683531/how-to-import-existing-git-repository-into-another" target="_blank" rel="external">How to import existing GIT repository into another</a>和<a href="https://github.com/deercoder/Linux/blob/master/Git/git_merge_local_repos.md" target="_blank" rel="external">合并已存在的git仓库</a></p>
<h3 id="WebView浏览位置的保存和恢复">WebView浏览位置的保存和恢复</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存位置</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">savePosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LogUtils.v(TAG, <span class="string">"savePosition()"</span>);</span><br><span class="line">    <span class="keyword">float</span> top = getTop();</span><br><span class="line">    <span class="keyword">float</span> contentHeight = getContentHeight();</span><br><span class="line">    <span class="keyword">float</span> scrollY = getScrollY();</span><br><span class="line">    mSavedPosition = (scrollY - top) / contentHeight;</span><br><span class="line">    <span class="keyword">return</span> mSavedPosition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复位置</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">restorePosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LogUtils.v(TAG, <span class="string">"restorePosition()"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mSavedPosition &gt; <span class="number">0f</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> top = getTop();</span><br><span class="line">        <span class="keyword">float</span> contentHeight = getContentHeight();</span><br><span class="line">        <span class="keyword">float</span> height = contentHeight - top;</span><br><span class="line">        <span class="keyword">float</span> positionInViewPort = height * mSavedPosition;</span><br><span class="line">        <span class="keyword">int</span> positionY = Math.round(top + positionInViewPort);</span><br><span class="line">        scrollTo(<span class="number">0</span>, positionY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSavedPosition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用拨号键盘的SecretCode功能">使用拨号键盘的SecretCode功能</h3><p>Android的拨号键盘有一些特殊的定义键，可以启动自定义的Intent，用法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">receiver</span> <span class="attribute">android:name</span>=<span class="value">".receiver.DiagnoserReceiver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.provider.Telephony.SECRET_CODE"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">"android_secret_code"</span> <span class="attribute">android:host</span>=<span class="value">"111222"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考资料：<br><a href="http://udinic.wordpress.com/2013/05/17/create-a-secret-doorway-to-your-app/" target="_blank" rel="external">Create a secret doorway to your app</a><br><a href="https://code.google.com/p/android-roms/wiki/Secret_Star_Codes" target="_blank" rel="external">Secret_Star_Codes</a></p>
<h3 id="阻止点击DrawLayout时事件传递到下一层">阻止点击DrawLayout时事件传递到下一层</h3><p>方法是给Drawlayout添加一个OnClickListener<br>参考资料：<br><a href="http://stackoverflow.com/questions/18811973/android-how-do-i-keep-drawerlayout-from-passing-touch-events-to-the-underlying" target="_blank" rel="external">How do I keep DrawerLayout from passing touch events to the underlying view</a></p>
<h3 id="没有root的情况下如何adb_pull_/data/data/package/下的数据">没有root的情况下如何adb pull /data/data/package/下的数据</h3><p>下面是一个查看应用数据库的例子脚本：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE_NAME=com.your.<span class="keyword">package</span></span><br><span class="line">DB_NAME=data.db</span><br><span class="line">rm -rf <span class="variable">$&#123;DB_NAME&#125;</span></span><br><span class="line">adb shell <span class="string">"run-as <span class="subst">$&#123;PACKAGE_NAME&#125;</span> chmod 666 /data/data/<span class="subst">$&#123;PACKAGE_NAME&#125;</span>/databases/<span class="subst">$&#123;DB_NAME&#125;</span>"</span></span><br><span class="line">adb pull /data/data/<span class="variable">$&#123;PACKAGE_NAME&#125;</span>/databases/<span class="variable">$&#123;DB_NAME&#125;</span> /tmp/</span><br><span class="line">adb shell <span class="string">"run-as <span class="subst">$&#123;PACKAGE_NAME&#125;</span> chmod 600 /data/data/<span class="subst">$&#123;PACKAGE_NAME&#125;</span>/databases/<span class="subst">$&#123;DB_NAME&#125;</span>"</span></span><br><span class="line">sqlite3 /tmp/$&#123;DB_NAME</span><br></pre></td></tr></table></figure>
<p>分析见：<br> <a href="http://stackoverflow.com/questions/18471780/android-adb-retrieve-database-using-run-as" target="_blank" rel="external">android adb, retrieve database using run-as</a><br><a href="http://blog.shvetsov.com/2013/02/access-android-app-data-without-root.html" target="_blank" rel="external">Access Android app data without root</a></p>
<h3 id="快速获取电池电量的方法">快速获取电池电量的方法</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Intent getBatteryStatus(Context context) &#123;</span><br><span class="line">    Context appContext = context.getApplicationContext();</span><br><span class="line">    <span class="keyword">return</span> appContext.registerReceiver(<span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IntentFilter(Intent.ACTION_BATTERY_CHANGED));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> getBatteryInfo(Context context, Intent batteryIntent) &#123;</span><br><span class="line">    <span class="built_in">int</span> status = batteryIntent.getIntExtra(BatteryManager.EXTRA_STATUS, -<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">boolean</span> isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING ||</span><br><span class="line">            status == BatteryManager.BATTERY_STATUS_FULL;</span><br><span class="line">    <span class="built_in">int</span> chargePlug = batteryIntent.getIntExtra(BatteryManager.EXTRA_PLUGGED, -<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">boolean</span> usbCharge = chargePlug == BatteryManager.BATTERY_PLUGGED_USB;</span><br><span class="line">    <span class="built_in">boolean</span> acCharge = chargePlug == BatteryManager.BATTERY_PLUGGED_AC;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> level = batteryIntent.getIntExtra(BatteryManager.EXTRA_LEVEL, -<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">int</span> <span class="built_in">scale</span> = batteryIntent.getIntExtra(BatteryManager.EXTRA_SCALE, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> batteryPct = level / (<span class="built_in">float</span>) <span class="built_in">scale</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Battery Info: isCharging="</span> + isCharging</span><br><span class="line">            + <span class="string">" usbCharge="</span> + usbCharge + <span class="string">" acCharge="</span> + acCharge</span><br><span class="line">            + <span class="string">" batteryPct="</span> + batteryPct;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析见：<a href="http://stackoverflow.com/questions/3661464/get-battery-level-before-broadcast-receiver-responds-for-intent-action-battery-c" target="_blank" rel="external">Get battery level before broadcast receiver responds for Intent.ACTION_BATTERY_CHANGED</a></p>
<h3 id="ActionBar的Title是否可以点击的问题">ActionBar的Title是否可以点击的问题</h3><p>4.2之前和之后这个有变化，4.2之前只有Icon可以点击，如果没有Icon，Title就无法点击，4.2之后是Title和Icon一起作为点击区域<br>分析见：<a href="http://stackoverflow.com/questions/16209963/action-bar-icon-as-up-enabled-not-the-title/16216966#16216966" target="_blank" rel="external">Action Bar icon as up enabled not the title</a> </p>
<h3 id="Webview滚动时背景闪烁的问题">Webview滚动时背景闪烁的问题</h3><p>因是渲染帧数不够<br>如果使用软件渲染，看下文：<a href="http://stackoverflow.com/questions/17315815/strange-webview-black-blinking-when-scrolling" target="_blank" rel="external">Strange webview black blinking when scrolling</a>，或者启用硬件加速</p>
<h3 id="Java中使用try_catch的性能问题">Java中使用try catch的性能问题</h3><p>使用try catch并没有额外的性能损耗，只有异常真正发生时才会有性能损耗，详细分析见：<a href="http://stackoverflow.com/questions/2633834/should-java-try-blocks-be-scoped-as-tightly-as-possible" target="_blank" rel="external">Should java try blocks be scoped as tightly as possible</a></p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/02/25/android-dev-notes-02/">
                Android开发杂记（二）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2014-02-25
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/Android/">Android</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/02/25/android-dev-notes-02/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/02/25/android-dev-notes-02/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>2013年下半年的Android开发过程中记录的一些经验和教训，整理出来一部分</p>
<h3 id="Fragment的状态恢复问题_[20131218]">Fragment的状态恢复问题 [20131218]</h3><p>在FragmentActivity里，如果存在Fragment，系统恢复被销毁的Activity的同时会回复所有FragmentManager里的Fragment列表，然后添加到当前的Activity中，但问题是，Fragment虽然恢复了，状态却没有回复，这些都需要在onCreate或onRestoreInstanceState中手动处理。</p>
<p>FragmentActivity恢复状态的源码如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onCreate()中</span></span><br><span class="line"><span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">    Parcelable p = savedInstanceState.getParcelable(FRAGMENTS_TAG);</span><br><span class="line">    <span class="comment">// FragmentManager的restoreAllState会将之前保存的Fragment重新添加到FragmentManager中，并恢复BackStack</span></span><br><span class="line">    mFragments.restoreAllState(p, nc != <span class="literal">null</span> ? nc.fragments : <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存状态的源码如下：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Save <span class="literal">all</span> appropriate <span class="keyword">fragment</span> <span class="keyword">state</span>.</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected void <span class="keyword">on</span>SaveInstanceState(Bundle <span class="keyword">out</span>State) &#123;</span><br><span class="line">    super.<span class="keyword">on</span>SaveInstanceState(<span class="keyword">out</span>State);</span><br><span class="line">    Parcelable p = mFragments.saveAllState();</span><br><span class="line">    if (p != null) &#123;</span><br><span class="line">        <span class="keyword">out</span>State.putParcelable(FRAGMENTS_TAG, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Google建议onCreate中只在savedInstanceState为null的时候才创建和初始化Fragment，代码如下：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="params">(savedInstanceState == null)</span> &#123;</span><br><span class="line">            <span class="comment">// During initial setup, plug in the details fragment.</span></span><br><span class="line">            DetailsFragment details = new DetailsFragment<span class="params">()</span>;</span><br><span class="line">            details.setArguments<span class="params">(getIntent<span class="params">()</span>.getExtras<span class="params">()</span>)</span>;</span><br><span class="line">            getFragmentManager<span class="params">()</span>.beginTransaction<span class="params">()</span>.add<span class="params">(android.R.id.content, details)</span>.commit<span class="params">()</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>补充说明：onCreate()和onRestoreInstanceState()都可以用于应用的状态恢复，区别是onRestoreInstanceState()是在onStart()之后调用，可以根据具体情况选择时机。</p>
<h3 id="裁剪图片的Intent_[20131218]">裁剪图片的Intent [20131218]</h3><p>Android系统自带了Gallery和Camera，提供了剪裁和编辑图片功能，虽然没有提供一个文档化的接口，但通常还是可以安全的调用，两种方法都需要在onActivityResult()里处理裁剪结果。</p>
<p>方法一：对已有的图片进行裁剪，Intent如下：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public static final String ACTION_CROP = <span class="string">"com.android.camera.action.CROP"</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *   裁剪已有的图片</span><br><span class="line"> * @param activity 接受裁剪结果的Activity</span><br><span class="line"> * @param srcUri 原始图片Uri</span><br><span class="line"> * @param destUri 保存裁剪后图片的Uri</span><br><span class="line"> */</span></span><br><span class="line">public static void showCrop<span class="params">(Activity activity, Uri srcUri, Uri destUri)</span> &#123;</span><br><span class="line">    Intent intent = new Intent<span class="params">(ACTION_CROP)</span>;</span><br><span class="line">    <span class="comment">// 看源码得知，使用setData会清除type，直接setType会清除data</span></span><br><span class="line">    intent.setDataAndType<span class="params">(srcUri, <span class="string">"image/*"</span>)</span>;</span><br><span class="line">    <span class="comment">//set crop properties</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"crop"</span>, <span class="string">"true"</span>)</span>;</span><br><span class="line">    <span class="comment">//indicate aspect of desired crop</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"aspectX"</span>, <span class="number">1</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"aspectY"</span>, <span class="number">1</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"scale"</span>, <span class="literal">true</span>)</span>;</span><br><span class="line">    <span class="comment">//indicate output X and Y</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"outputX"</span>, Constants.AVATAR_DIMEN_MEDIUM)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"outputY"</span>, Constants.AVATAR_DIMEN_MEDIUM)</span>;</span><br><span class="line">    <span class="comment">//retrieve data on return</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"return-data"</span>, <span class="literal">false</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"noFaceDetection"</span>, <span class="literal">true</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"setWallpaper"</span>, <span class="literal">false</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(MediaStore.EXTRA_OUTPUT, destUri)</span>;</span><br><span class="line">    activity.startActivityForResult<span class="params">(intent, Constants.REQUEST_CROP)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法二，选择图片的同时执行裁剪操作：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> *   选择并裁剪图片</span><br><span class="line"> * @param activity 接受裁剪结果的Activity</span><br><span class="line"> * @param destUri 保存裁剪后图片的Uri</span><br><span class="line"> */</span></span><br><span class="line">public static void showCrop<span class="params">(Activity activity, Uri destUri)</span> &#123;</span><br><span class="line">    Intent intent = new Intent<span class="params">(Intent.ACTION_GET_CONTENT)</span>;</span><br><span class="line">    intent.setType<span class="params">(<span class="string">"image/*"</span>)</span>;</span><br><span class="line">    <span class="comment">//set crop properties</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"crop"</span>, <span class="string">"true"</span>)</span>;</span><br><span class="line">    <span class="comment">//indicate aspect of desired crop</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"aspectX"</span>, <span class="number">1</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"aspectY"</span>, <span class="number">1</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"scale"</span>, <span class="literal">true</span>)</span>;</span><br><span class="line">    <span class="comment">//indicate output X and Y</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"outputX"</span>, Constants.AVATAR_DIMEN_MEDIUM)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"outputY"</span>, Constants.AVATAR_DIMEN_MEDIUM)</span>;</span><br><span class="line">    <span class="comment">//retrieve data on return</span></span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"return-data"</span>, <span class="literal">false</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"noFaceDetection"</span>, <span class="literal">true</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(<span class="string">"setWallpaper"</span>, <span class="literal">false</span>)</span>;</span><br><span class="line">    intent.putExtra<span class="params">(MediaStore.EXTRA_OUTPUT, destUri)</span>;</span><br><span class="line">    activity.startActivityForResult<span class="params">(intent, Constants.REQUEST_GALLERY)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="加载资源的另一种方法_[20131218]">加载资源的另一种方法 [20131218]</h3><p>Android系统中有多重方法加载资源文件，比如读取drawable目录的图片可以用getResources().getDrawable()，读取values目录的字符串可以用getResources().getString()，读取raw目录的文件可以用getResources().openRawResource()，读取assets目录的文件可以用getAssets().open()，这些都是Android系统特有的方法，除此之外，我们还可以用Java提供的加载资源的方法，这种方法不受位置限制，可以放在源文件相同的目录，下面是例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比如要加载src/com/douban/shuo/res/目录下的icon.png图片</span></span><br><span class="line"><span class="comment">// 可以这样做：</span></span><br><span class="line"><span class="built_in">String</span> path = <span class="string">"com/douban/shuo/res/icon.png"</span>;</span><br><span class="line">InputStream <span class="keyword">is</span> = getClassLoader().getResourceAsStream(path);</span><br><span class="line">Drawable.createFromStream(<span class="keyword">is</span>, <span class="string">"src"</span>);</span><br></pre></td></tr></table></figure>
<p>getResourceAsStream是JDK 1.1开始就有的方法，可以通过ClassLoader加载任何格式的资源，返回一个InputStream供使用，具体路径解析规则可以看看这篇文章<a href="http://blog.csdn.net/ouyang_peng/article/details/8856764" target="_blank" rel="external">ClassLoader.getResourceAsStream() 与 Class.getResourceAsStream()的区别</a></p>
<h3 id="在onActivityResult中显示Dialog_[20131218]">在onActivityResult中显示Dialog [20131218]</h3><p>有时会遇到这样的场景，通过startActivityForResult调用某一个应用等待返回结果，然后在onActivityResult中需要异步处理的同时显示对话框，如果直接在onActivityResult中调用Dialog.show()会报错，因为onActivityResult是在onResume之前，一个类似的问题是，在onSaveInstanceState调用之后也不能进行FragmentTransaction的commit操作，这两个都影响到DialogFragment，正确的做法有两种：</p>
<ul>
<li>方法一：在onPostResume显示对话框</li>
<li>方法二：在onActivityResult设置一个标志(比如mPendingShowDialog)为true，然后在onResume()的时候检查标志，如果为true就显示对话框</li>
</ul>
<p>注意：不仅是Dialog，处理Fragment相关的transactions和commit操作都需要考虑这个问题，在onSaveInstanceState调用之后如果需要commit，请替换成commitAllowingStateLoss，如果不允许状态丢失，就需要寻找其它替代方法。</p>
<p>详细解释可以参考：<a href="http://stackoverflow.com/questions/16265733/failure-delivering-result-onactivityforresult" target="_blank" rel="external">“Failure Delivering Result ” - onActivityForResult</a>。</p>
<h3 id="建议所有ID都定义在values里面_[20131218]">建议所有ID都定义在values里面 [20131218]</h3><p>MenuItem ID最好和其它的resource id一样，定义在values里面，可以避免冲突，直接使用系统的Menu.FIRST递增容易冲突，比如和ShareActionProvider冲突(测试时看到使用的ID是2，Menu.FIRST值为1)</p>
<h3 id="Fragment的背景问题_[20131017]">Fragment的背景问题 [20131017]</h3><p>如果使用Activity+Fragment的结构的话，一般至少会有三种背景，最底层的是Theme的背景，属性为<code>android:windowBackgroun d</code>，这个如果没有设置默认是白色/黑色（依主题不同），中间层是Activity的<code>android:background</code>，上面一层是Fragment的<code>android:background</code>,如果Fragment里面的View也有背景的话就会有多层背景，会有过度绘制的问题，性能会下降很多，4.1以上的系统的开发者选项里有一个<strong>[显示GPU过度绘制]</strong>选项，开启后会用颜色表示过度绘制的区域，从最优到最差依次是蓝绿淡红和红，除了个别图标和层次较深的文字以外，一般如果大片区域出现淡红色和红色就是比较严重的性能问题，特别是在ListView等多层嵌套的控件里。</p>
<p>这时候就需要针对性的进行优化，一般有两种方法：</p>
<ol>
<li>优化布局，尽量减少层次，典型的如使用RelativeLayout，使用merge，使用Canvas直接绘制（极端情况下，阅读类应用很多都是这样）等；</li>
<li>去除不必要的背景，没有特殊需要的话，Activity不设置背景，大部分情况下Fragment也可以不设置背景，网上建议将android:windowBackground设置为@null在很多时候会有问题，比如Activity被销毁再打开的时候会呈现短暂的黑色背景（其实是没有背景），如果Activity不设置背景在某些情况下也会出现这种情况，特别是在内存不足Activity被销毁后从最近任务列表返回时。</li>
</ol>
<blockquote>
<p>Fragment不设置背景存在的问题是，如果采用的是一个Activity+多个Fragment切换的结构，在部分机型上，Fragment切换后，前一个Fragment的画面会残留在背景上，造成重影现象，原因应该是系统认为Fragment没有设置背景所以没有强制刷新，真正的原因需要看源码才能确定。</p>
</blockquote>
<p>更详细的绘图性能调优方法可以参考<a href="http://www.curious-creature.org/2012/12/01/android-performance-case-study/" target="_blank" rel="external">Android Performance Case Study</a>，具体应用时，还需要考虑到小米/魅族等机型和2.3系统的兼容性问题</p>
<h3 id="魅族M9的资源解析_[20131017]">魅族M9的资源解析 [20131017]</h3><p>如果在res目录里存在不能识别的资源ID会直报InflateException导致Crash，M9使用2.3系统，不能识别3.0以上才支持的ActionBar相关的属性，比如 <code>android:actionBarStyle</code> ，所以使用ActionBarSherlock时，ActionBar相关的属性必须分开放，不带android命名空间的放在values目录，带android命名空间的必须放在values-v14目录，这个之前Bear的日记里也有提到，具体见 <a href="https://github.com/JakeWharton/ActionBarSherlock/issues/446" target="_blank" rel="external">ABS causes an InflateException on some devices</a></p>
<h3 id="摩托ME525的ListView显示_[20131017]">摩托ME525的ListView显示 [20131017]</h3><p>如果ListView设置了MATCH_PARENT但是内容太少又没有撑满空间，ListView会自动缩小至显示内容所需区域，空白空间会显示默认的背景色，在ME525上是灰色块，解决办法是在主题里加上：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;item name=<span class="string">"android:overScrollFooter"</span>&gt;<span class="variable">@android</span><span class="symbol">:color/transparent&lt;/item&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者在布局里使用</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">android:</span>overScrollFooter=<span class="string">"@android:color/transparent"</span></span><br></pre></td></tr></table></figure>
<p>具体见 <a href="http://stackoverflow.com/questions/10655646/background-color-listview" target="_blank" rel="external">Background color (listview?)</a></p>
<h3 id="ImageView的adjustViewBounds属性_[20131017]">ImageView的adjustViewBounds属性 [20131017]</h3><ol>
<li><p>adjustViewBounds属性设置为true的作用是保持原始图片的长宽比，某些情况下这可能不是你想要的效果，比如广播里缩略图需要保持正方形，这时候你需要手动设置长和宽，不能使用WRAP_CONTENT，也可以重写ImageView的onMeasure()方法强制保持长宽一致，广播源码里的SquaredCheckableImage就是重写了onMeasure()方法：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">	setMeasuredDimension(getMeasuredWidth(), getMeasuredWidth());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>maxHeight</code>和<code>maxWidth</code>属性必须同时设置<code>adjustViewBounds</code>为true才能生效，原因见<code>ImageView.onMeasure()</code>方法的源码，只有<code>mAdjustViewBounds</code>为true时才会检查并设置<code>resizeWidth</code>和<code>resizeHeight</code>两个布尔值，只有当这两个值至少一个为true时才会进行调整ImageView大小的缩放操作；3. 设置<code>adjustViewBounds</code>为true会导致<code>scaleType</code>重置为FIT_CENTER，源码里setAdjustViewBounds方法里有这样一句：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setAdjustViewBounds</span><span class="params">(<span class="keyword">boolean</span> adjustViewBounds)</span> </span>&#123;</span><br><span class="line">	mAdjustViewBounds = adjustViewBounds;</span><br><span class="line">	<span class="keyword">if</span> (adjustViewBounds) &#123;</span><br><span class="line">		setScaleType(ScaleType.FIT_CENTER);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体见官方文档和ImageView的源码，还有这里 <a href="http://stackoverflow.com/questions/10917388/android-adjustviewbounds-bug" target="_blank" rel="external">android adjustViewBounds bug?</a></p>
<h3 id="ListView中Item的点击状态_[20131017]">ListView中Item的点击状态 [20131017]</h3><p>在小米1S等手机中，如果ListView的Item非常复杂，Item的子View的PRESS_STATE可能有问题，在小米1S上的表现就是ListView的onItemClick事件会触发该Item所有子View的PRESSED和FOCUSED状态，如果某些View设置了StateListDrawable为背景，就可以看到Drawable的状态变了，设置<code>android:duplicateParentState</code> <code>android:descendantFocusability</code> <code>android:focusable</code> <code>android:focusableInTouchMode</code> <code>android:clickable</code> 均没有效果，StackOverFlow上给出的解决办法（以LinearLayout为例）：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">NoPressStateLinearLayout</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">LinearLayout</span> &#123;</span></span><br><span class="line">	......</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public void setPressed(boolean pressed) &#123;</span><br><span class="line"><span class="comment">//        super.setPressed(pressed);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果上面的办法还不行，也可以这样：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">NoPressStateLinearLayout</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">LinearLayout</span> &#123;</span></span><br><span class="line">	......</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void dispatchSetPressed(boolean pressed) &#123;</span><br><span class="line">        <span class="comment">// avoid handing on the event to the child views</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，如果子View需要处理这些状态，可能会有冲突，ListView的事件响应问题还可以参考 <a href="http://cyrilmottier.com/2011/11/23/listview-tips-tricks-4-add-several-clickable-areas/" target="_blank" rel="external">ListView Tips &amp; Tricks #4: Add Several Clickable Areas</a></p>
<h3 id="Shape_Drawable填充问题_[20131017]">Shape Drawable填充问题 [20131017]</h3><p>广播里需要用到一个自定义的带边框的Button背景，开始我写的是这样的：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">shape</span> xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">       android:<span class="built_in">shape</span>=<span class="string">"rectangle"</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">stroke</span></span><br><span class="line">            android:<span class="variable">width</span>=<span class="string">"1dp"</span></span><br><span class="line">            android:<span class="built_in">color</span>=<span class="string">"@color/soft_white"</span>/&gt;</span><br><span class="line">    &lt;corners</span><br><span class="line">            android:radius=<span class="string">"1dp"</span>/&gt;</span><br><span class="line">&lt;/<span class="built_in">shape</span>&gt;</span><br></pre></td></tr></table></figure>
<p>只是一个边框，大部分机子上这样就可以了，但是在部分索尼（如我的Xperia U上）和摩托的机子（如ME525）上会出现只有边框，中间部分是全黑的，原因是这个Shape只有边框，中间的区域没有东西（没有任何颜色绘制），正常情况没有东西就不会绘制任何东西，但是部分机子不知道为何会填充默认的黑色背景，解决办法是中间区域设置为透明，修改后的drawable如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">shape</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">       <span class="attribute">android:shape</span>=<span class="value">"rectangle"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--内部用透明色填充--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">solid</span></span><br><span class="line">            <span class="attribute">android:color</span>=<span class="value">"@color/transparent"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">stroke</span></span><br><span class="line">            <span class="attribute">android:width</span>=<span class="value">"1dp"</span></span><br><span class="line">            <span class="attribute">android:color</span>=<span class="value">"@color/soft_white"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">corners</span></span><br><span class="line">            <span class="attribute">android:radius</span>=<span class="value">"1dp"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">shape</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="HTTP发送大量数据_[20131017]">HTTP发送大量数据 [20131017]</h3><p>2.0版广播支持发布带图和图片批量上传，测试过程发现在Nexus S 2.3系统上多次出现发送失败但是又没有抛异常的情况，后来找到原因了，是natalya库里的HttpRequest里使用的SimpleMultipartEntity处理Multipart类型数据有问题，代码：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">   ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">   ......</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> addPart(<span class="keyword">final</span> <span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">final</span> <span class="keyword">String</span> fileName, <span class="keyword">final</span> InputStream fin, <span class="keyword">String</span> type, <span class="keyword">final</span> <span class="built_in">boolean</span> isLast)&#123;</span><br><span class="line">......</span><br><span class="line">           out.write(<span class="string">"Content-Transfer-Encoding: binaryrnrn"</span>.getBytes());</span><br><span class="line">		<span class="comment">// 这里会读取InputStream并全部写入到ByteArrayOutputStream中，数据量大时会造成OOM</span></span><br><span class="line">           <span class="keyword">final</span> <span class="built_in">byte</span>[] tmp = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4096</span>];</span><br><span class="line">           <span class="built_in">int</span> l = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">while</span> ((l = fin.read(tmp)) != -<span class="number">1</span>) &#123;</span><br><span class="line">               out.write(tmp, <span class="number">0</span>, l);</span><br><span class="line">           &#125;</span><br><span class="line">......</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>加注释的那一行就是问题所在，上传文件时会一次性读取全部的数据流并写入到ByteArrayOutputStream，超过一定限制时会造成OOM。<br><a href="http://developer.android.com/reference/java/net/HttpURLConnection.html" target="_blank" rel="external">HttpURLConnection</a> 文档里说明了POST数据时，HttpURLConnection默认是读取全部数据到内存然后再通过网络发送，如果数据量过大建议使用<code>setFixedLengthStreamingMode(int)</code>（知道需要POST的数据流的精确长度时）或<code>setChunkedStreamingMode(int)</code>（无法计算或不知道需要POST的数据流的精确长度时）:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Posting Content</span><br><span class="line"></span><br><span class="line">To upload data to <span class="tag">a</span> web server, configure the connection <span class="keyword">for</span> output using <span class="function"><span class="title">setDoOutput</span><span class="params">(true)</span></span><span class="class">.For</span> best performance, you should call either `<span class="function"><span class="title">setFixedLengthStreamingMode</span><span class="params">(int)</span></span>` when the <span class="tag">body</span> length is known <span class="keyword">in</span> advance, or `<span class="function"><span class="title">setChunkedStreamingMode</span><span class="params">(int)</span></span>` when it is not. Otherwise HttpURLConnection will be forced to buffer the complete request <span class="tag">body</span> <span class="keyword">in</span> memory before it is transmitted, wasting (and possibly exhausting) heap and increasing latency.</span><br></pre></td></tr></table></figure>
<h3 id="时区与日期显示问题_[20131017]">时区与日期显示问题 [20131017]</h3><p>现在豆瓣API返回的日期字符串默认都是东八区的本地时间，实际显示时如果不考虑时区，在东八区以外的地区就会有问题，特别是用于和本地时间比较时，所以解析API返回的日期字符串时需要给DateFormat设置时区，这样解析出来的Date才是对的，方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API时间的默认时区</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TimeZone TIME_ZONE_CHINA = TimeZone.getTimeZone(<span class="string">"GMT+8"</span>);</span><br><span class="line"><span class="comment">// 豆瓣API返回的时间格式</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATE_FORMAT_STRING = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Date <span class="title">parseDate</span><span class="params">(String dateStr)</span> </span>&#123;</span><br><span class="line">    DateFormat df = <span class="keyword">new</span> SimpleDateFormat(DATE_FORMAT_STRING);</span><br><span class="line">    df.setTimeZone(TIME_ZONE_CHINA);</span><br><span class="line">    <span class="keyword">final</span> ParsePosition position = <span class="keyword">new</span> ParsePosition(<span class="number">0</span>);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> df.<span class="title">parse</span><span class="params">(dateStr, position)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用adb备份和恢复应用数据_[20131218]">用adb备份和恢复应用数据 [20131218]</h3><p>日常开发过程中有时会碰到app签名不一致需要卸载重新安装的问题，重新安装之后之前的应用配置和数据就都丢失了，有个技巧可以在卸载前备份数据，在重新安装后恢复数据：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设包名是 com.douban.shuo</span></span><br><span class="line"><span class="comment">// 备份包名对应app的数据</span></span><br><span class="line">adb backup com<span class="class">.douban</span><span class="class">.shuo</span></span><br><span class="line"><span class="comment">// 从备份中恢复数据</span></span><br><span class="line">adb restore backup.ab</span><br></pre></td></tr></table></figure>
<p>注意：使用前提是手机已经解锁，其实adb backup/restore是系统提供的一个备份工具，可以用于整机备份，有兴趣的可以这篇文章：<a href="http://forum.xda-developers.com/showthread.php?t=1420351" target="_blank" rel="external">Full Phone Backup without Unlock or Root</a>，至于通过代码的方式备份和恢复应用数据，可以参考官方文档，国内的话由于网络原因估计不太好用：<a href="http://developer.android.com/guide/topics/data/backup.html" target="_blank" rel="external">Data Backup</a></p>
<h3 id="APK签名检测脚本_[20131218]">APK签名检测脚本 [20131218]</h3><p>写了一个简单的apk签名检测脚本，可以显示签名的详细信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment">#jarsigner -verify -verbose -certs $1</span></span><br><span class="line">INPUT=<span class="variable">$1</span></span><br><span class="line">OUTPUT=apk.tmp</span><br><span class="line">rm -rf <span class="variable">$&#123;OUTPUT&#125;</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &gt; /dev/null</span><br><span class="line">unzip <span class="variable">$&#123;INPUT&#125;</span> <span class="operator">-d</span> <span class="variable">$&#123;OUTPUT&#125;</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &gt; /dev/null</span><br><span class="line">openssl pkcs7 -inform DER -noout -print_certs -text -in <span class="variable">$&#123;OUTPUT&#125;</span>/META-INF/CERT.RSA</span><br><span class="line">rm -rf <span class="variable">$&#123;OUTPUT&#125;</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &gt; /dev/null</span><br></pre></td></tr></table></figure>
<h3 id="切换Android_Studio的默认构建类型_[20131218]">切换Android Studio的默认构建类型 [20131218]</h3><p>Android Studio—View—Tool Windows—Build Variants可以切换，一般默认建议使用release签名+开启debug的构建类型，以广播饿为例，build.gradle有如下配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">buildTypes</span> &#123;</span><br><span class="line">    <span class="title">release</span> &#123;</span><br><span class="line">        <span class="title">signingConfig</span> signingConfigs.release</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    beta &#123;</span><br><span class="line">        <span class="title">signingConfig</span> signingConfigs.release</span><br><span class="line">        debuggable <span class="built_in">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">debug</span> &#123;</span><br><span class="line">        <span class="title">packageNameSuffix</span> null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android Studio中设置默认使用beta构建类型，build生成的apk默认使用release签名，但是BuildConfig.DEBUG为true，debug为true便于调试，使用release签名避免了给其他人测试时，或者使用qaci的构建包时签名冲突，当然，也有其它的解决办法，比如所有人使用统一的debug签名，我觉得使用buildTypes比较灵活，还可以自定义很多其它选项，比如修改包名，修改应用名，版本名，添加构建时间等。</p>
<h3 id="Idea插件QAPlug_[20131017]">Idea插件QAPlug [20131017]</h3><p>  IDEA有很多有用的插件，我推荐一个<a href="http://qaplug.com/" target="_blank" rel="external">QAPlug</a>，这个插件包含几个独立的模块(<a href="http://plugins.jetbrains.com/search/index?pr=idea&amp;search=qaplug" target="_blank" rel="external">Findbugs/PMD/CheckStyle</a>)，可选择安装，Findbugs是一个代码缺陷检测工具，可以帮助寻找代码中的各种隐患或潜在的性能问题；PMD是一个静态代码分析工具，可以检查复杂的逻辑结构/资源使用/重复代码等问题，帮助提高代码质量；CheckStyle则专注于代码规范，可以检查命名约定/类设计/方法设计/import/空白等。这三个工具都可以指定自定义的规则，推荐每次版本发布前对代码进行一次全面的检查，有些提示是不需要修改的，但是还是能发现一些潜在的问题的，对于Android,还要做的一个检查是Lint，版本发布前对代码做一个全面的检查至少可以避免一些平时因疏忽导致的低级问题。这个插件和IDEA集成，使用起来非常简单，官网页面有详细的说明。</p>
<h3 id="跳转到第三方应用无法返回的问题_[20131218]">跳转到第三方应用无法返回的问题 [20131218]</h3><p>广播的时间线有很多地方可以点击跳转到第三方应用，比如电影/FM/小组/浏览器等 ，测试发现奇怪的问题，跳转到第三方应用后，按返回键没有返回到广播，直接返回到手机桌面了，后来发现是FLAG_ACTIVITY_NEW_TASK的问题，使用Intent跳转到其它应用，如果没有添加Intent.FLAG_ACTIVITY_NEW_TASK标志，按返回键时不能返回到上一个应用，在4.1以上系统上都是如此。所以，建议在使用Intent跳转到第三方应用的地方添加Intent.FLAG_ACTIVITY_NEW_TASK标志（选择图片等功能不需要，这时候他们位于同一个TASK）。</p>
<p>系统的某些功能和应用也存在这个问题，在某个应用处于前台时，如果点击通知栏的一个通知跳转到了其它应用，返回时有可能直接返回了手机桌面，而不是当前应用。</p>
<h3 id="无法直接启动其它应用的Activity_[20131218]">无法直接启动其它应用的Activity [20131218]</h3><p>广播的上传通知点击后会弹出一个对话框形式的Activity，有几次点击没反应，log里看到如下的错误信息：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12-03 15:52:33.133 611-622/? W/ActivityManager﹕ Permission Denial: starting Intent &#123; flg=0x10000000 cmp=com.douban.shuo/.app.UploadNotifyActivity bnds=[<span class="link_label">0,102</span>][<span class="link_reference">768,230</span>] (has extras) &#125; from null (pid=-1, uid=10191) not exported from uid 10192</span><br><span class="line">12-03 15:52:33.133 611-622/? W/ActivityManager﹕ Unable to send startActivity intent</span><br><span class="line">java.lang.SecurityException: Permission Denial: starting Intent &#123; flg=0x10000000 cmp=com.douban.shuo/.app.UploadNotifyActivity bnds=[<span class="link_label">0,102</span>][<span class="link_reference">768,230</span>] (has extras) &#125; from null (pid=-1, uid=10191) not exported from uid 10192</span><br></pre></td></tr></table></figure>
<p>而且只有4.4的系统存在这个问题，查资料后发现从4.4版本开始，使用ClassName方式直接调用第三方Activity是不允许的，需要目标Activity在AndroidManifest里面明确声明了android:exported=”true” 才可以，需要注意的是，不仅仅是第三方应用，只要是不同的进程，都必须声明为android:exported=”true”，Activity才可以被直接调用。</p>
<h3 id="Kitkat系统WebView的换行问题_[20131218]">Kitkat系统WebView的换行问题 [20131218]</h3><p>4.4开始，webview不会自动断行，需要在html里处理，代码里也可以这样处理：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="params">(MiscUtils.hasKitkat<span class="params">()</span>)</span> &#123;</span><br><span class="line">    settings.setLayoutAlgorithm<span class="params">(WebSettings.LayoutAlgorithm.TEXT_AUTOSIZING)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是很多网页这样不解决问题，还需要在Html里处理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">pre</span> <span class="attribute">style</span>=<span class="value">"word-wrap: break-word; white-space: pre-wrap;"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>@wuzeyi 说吃喝组里是直接在html里写上了word-break:break-all;有用到可以参考。</p>
<p>详细的方法可以看官方的说明：</p>
<p><a href="http://developer.android.com/guide/webapps/migrating.html#Columns" target="_blank" rel="external">http://developer.android.com/guide/webapps/migrating.html#Columns</a>和<a href="https://code.google.com/p/android/issues/detail?id=62378" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=62378</a></p>
<p>补充一点，4.2以后的系统，通过JS调用Java函数时，需要添加@JavascriptInterface这个Annotation，否则系统会忽略这个函数。</p>
<h3 id="Framelayout的margin设置无效的问题_[20131218]">Framelayout的margin设置无效的问题 [20131218]</h3><p>4.0以前的系统FrameLayout的margin设置有时不生效，查资料发现原因是没有设置layout_gravity，这是4.0之前系统个一个BUG，见<a href="https://code.google.com/p/android/issues/detail?id=28057" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=28057</a>，猜测是因为FrameLayout需要一个定位的锚点，布局文件里加入以下代码即可：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置上下margin必须有top，设置左右margin必须有left</span></span><br><span class="line"><span class="comment">// layout_gravity必须有一个值，margin才会生效</span></span><br><span class="line"><span class="string">android:</span>layout_gravity=<span class="string">"top|left"</span></span><br></pre></td></tr></table></figure>
<p>代码里可以这样设置：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MarginLayoutParams marginParams = new MarginLayoutParams<span class="params">(this.getLayoutParams<span class="params">()</span>)</span>;  </span><br><span class="line">marginParams.height = this.getMeasuredHeight<span class="params">()</span>;  </span><br><span class="line">marginParams.width = this.getMeasuredWidth<span class="params">()</span>;  </span><br><span class="line">marginParams.setMargins<span class="params">(l,t,r,b)</span>;  </span><br><span class="line">LayoutParams layoutParams = new LayoutParams<span class="params">(marginParams)</span>;  </span><br><span class="line"><span class="comment">// 起作用的是这一行</span></span><br><span class="line">layoutParams.gravity = Gravity.TOP|Gravity.LEFT;  </span><br><span class="line">setLayoutParams<span class="params">(layoutParams)</span>;</span><br></pre></td></tr></table></figure>
<p>参考文档：</p>
<p><a href="http://blog.csdn.net/fengye810130/article/details/9147695" target="_blank" rel="external">http://blog.csdn.net/fengye810130/article/details/9147695</a><br><a href="http://stackoverflow.com/questions/5401952/framelayout-margin-not-working" target="_blank" rel="external">http://stackoverflow.com/questions/5401952/framelayout-margin-not-working</a></p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  
  <div class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="mcxiaoke" />
          <p class="site-author-name">mcxiaoke</p>
        </div>
        <p class="site-description motion-element">零碎的笔记</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">27</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/mcxiaoke" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.douban.com/people/doiv" target="_blank">DouBan</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://mcxiaoke.com/" target="_blank">Home</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
              <a href="http://moment.douban.com/app/" target="_blank">豆瓣一刻</a>
              </span>
            
          
        </div>
        
      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2007 - 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">mcxiaoke</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"mcxiaoke"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  
  <script type="text/javascript" src="/js/analytics_google-analytics.js?v=0.4.3"></script>


</body>
</html>
